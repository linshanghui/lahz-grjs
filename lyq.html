<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç•™è¨€å¢™</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:system-ui, -apple-system, sans-serif}
body{background:#f7f7fa;padding:12px;max-width:600px;margin:0 auto}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;gap:8px}
.title{font-size:20px;font-weight:600;color:#222}
.btn{padding:8px 12px;border:none;border-radius:10px;font-size:14px;cursor:pointer}
.btn-primary{background:#409eff;color:#fff}
.btn-danger{background:#f56756;color:#fff}
.publish-card{background:#fff;border-radius:16px;padding:16px;margin-bottom:16px;box-shadow:0 2px 10px #0001}
.publish-card input,.publish-card textarea{width:100%;padding:12px 14px;border:1px solid #eee;border-radius:12px;margin-bottom:10px;outline:0;background:#fafafa}
.publish-card input:focus,.publish-card textarea:focus{border-color:#409eff}
.nick-preview{font-size:13px;color:#409eff;margin:-5px 0 10px;display:none}
.word-tip{font-size:13px;color:#666;margin:0 0 10px}
.publish-card textarea{min-height:100px;resize:none}
.publish-card button{width:100%;padding:12px;background:#409eff;color:#fff;border:none;border-radius:12px}
.message-wall{display:flex;flex-direction:column;gap:12px}
.message-item{background:#fff;border-radius:16px;padding:14px;position:relative;box-shadow:0 2px 8px #0001;display:flex;gap:12px}
.message-item.top{border:1px solid #ffd43b;background:#fffdf5}
.avatar{width:42px;height:42px;border-radius:50%;object-fit:cover;background:#eee;flex-shrink:0}
.msg-right{flex:1}
.name{font-weight:600;font-size:15px;color:#222;margin-bottom:6px;display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.top-tag{background:#ff7d00;color:#fff;font-size:11px;padding:2px 6px;border-radius:4px}
.tag-item{font-size:11px;padding:2px 6px;border-radius:4px;color:#fff}
.content{font-size:15px;line-height:1.5;color:#333;word-break:break-all}
.qq-time-ip{font-size:12px;color:#999;display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.admin-actions{position:absolute;top:10px;right:10px;display:none;gap:4px}
.act-del{background:#f56756;width:26px;height:22px;font-size:10px;border:none;border-radius:4px;color:#fff}
.act-block{background:#ff9f43;width:26px;height:22px;font-size:10px;border:none;border-radius:4px;color:#fff}
.act-top{background:#409eff;width:26px;height:22px;font-size:10px;border:none;border-radius:4px;color:#fff}
.act-edit{background:#722ed1;width:26px;height:22px;font-size:10px;border:none;border-radius:4px;color:#fff}
.edit-modal{position:fixed;inset:0;background:#00000080;display:none;justify-content:center;align-items:center;z-index:99999}
.edit-box{background:#fff;width:90%;max-width:400px;border-radius:16px;padding:20px}
.edit-box h4{margin-bottom:12px}
.edit-box input,.edit-box textarea{width:100%;padding:10px;margin-bottom:10px;border:1px solid #eee;border-radius:8px}
.edit-btns{display:flex;gap:10px;margin-top:10px}
.edit-btns button{flex:1;padding:10px;border:none;border-radius:8px}
.btn-save{background:#409eff;color:#fff}
.btn-cancel{background:#f1f1f1}
.backend-modal{position:fixed;inset:0;background:#00000040;display:none;z-index:9999}
.backend-box{background:#fff;height:100%;display:flex;flex-direction:column}
.backend-header{background:#409eff;color:#fff;padding:16px;display:flex;justify-content:space-between;align-items:center}
.backend-close{background:none;border:none;color:#fff;font-size:20px}
.backend-body{flex:1;padding:16px;overflow-y:auto;background:#f7f7fa}
.section{background:#fff;border-radius:14px;padding:16px;margin-bottom:14px}
.section h4{margin-bottom:12px}
.set-row{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
.set-row span{font-size:14px;color:#555}
.set-row input{padding:10px 12px;border:1px solid #eee;border-radius:10px;background:#fafafa}
textarea{width:100%;height:100px;padding:12px;border:1px solid #eee;border-radius:10px;resize:none}
.save-btn{width:100%;padding:11px;background:#409eff;color:#fff;border:none;border-radius:10px;margin-top:6px}
.black-item{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#fafafa;border-radius:10px;margin-bottom:8px}
.unblock{background:#409eff;color:#fff;border:none;padding:5px 9px;border-radius:6px;font-size:12px}
</style>
</head>
<body>

<div class="header">
  <div class="title">ğŸ’¬ ç•™è¨€å¢™</div>
  <div style="display:flex;gap:6px">
    <button class="btn btn-primary" onclick="openBackend()">ç®¡ç†</button>
    <button class="btn btn-danger" id="logoutBtn" style="display:none" onclick="logoutAdmin()">é€€å‡º</button>
  </div>
</div>

<div class="publish-card">
  <input id="qq" placeholder="è¾“å…¥QQå·" autocomplete="off">
  <div class="nick-preview" id="nickPreview"></div>
  <div class="word-tip" id="nickWordTip"></div>
  <textarea id="content" placeholder="è¾“å…¥å†…å®¹"></textarea>
  <div class="word-tip" id="contentWordTip"></div>
  <button onclick="postMsg()">å‘å¸ƒç•™è¨€</button>
</div>

<div class="message-wall" id="msgWall"></div>

<div class="edit-modal" id="editModal">
  <div class="edit-box">
    <h4>ç¼–è¾‘ç•™è¨€</h4>
    <input id="edit_name">
    <input id="edit_qq">
    <input id="edit_time">
    <input id="edit_ip">
    <textarea id="edit_content"></textarea>
    <input id="edit_tags">
    <div class="edit-btns">
      <button class="btn-cancel" onclick="closeEdit()">å–æ¶ˆ</button>
      <button class="btn-save" onclick="saveEdit()">ä¿å­˜</button>
    </div>
  </div>
</div>

<div class="backend-modal" id="backendModal">
  <div class="backend-box">
    <div class="backend-header">
      <h3>ç®¡ç†åå°</h3>
      <button class="backend-close" onclick="closeBackend()">Ã—</button>
    </div>
    <div class="backend-body">
      <div class="section">
        <h4>åŸºç¡€è®¾ç½®</h4>
        <div class="set-row"><span>æœ€å°‘å­—æ•°</span><input id="set_min"></div>
        <div class="set-row"><span>æœ€å¤šå­—æ•°</span><input id="set_max"></div>
        <div class="set-row"><span>æ˜µç§°æœ€å¤§é•¿åº¦</span><input id="set_nick_max"></div>
        <div class="set-row"><span>å‘è¨€é—´éš”ç§’</span><input id="set_cd"></div>
        <div class="set-row"><span>æ¨é€æ ‡é¢˜</span><input id="set_push_title"></div>
        <button class="save-btn" onclick="saveSetting()">ä¿å­˜</button>
      </div>
      <div class="section" style="background:#e6f7ff">
        <h4>æ¨é€</h4>
        <textarea id="pushContent"></textarea>
        <button class="save-btn" style="background:#52c41a" onclick="manualPush()">æ¨é€</button>
        <div style="display:flex;gap:8px;margin-top:8px">
          <div style="flex:1"><span>å°æ—¶</span><input type="number" id="pushHour"></div>
          <div style="flex:1"><span>åˆ†é’Ÿ</span><input type="number" id="pushMin"></div>
        </div>
        <div style="display:flex;gap:6px;margin-top:8px">
          <button style="flex:1;background:#ff9f43" class="save-btn" onclick="startDailyPush()">å¯åŠ¨å®šæ—¶</button>
          <button style="flex:1;background:#f56756" class="save-btn" onclick="stopDailyPush()">åœæ­¢</button>
        </div>
        <button style="background:#722ed1" class="save-btn" onclick="savePushConfigOnly()">ä¿å­˜é…ç½®</button>
        <div style="font-size:12px;color:#666;margin-top:8px">é“¾æ¥ï¼š<span id="autoPushUrl"></span></div>
      </div>
      <div class="section">
        <h4>æ•æ„Ÿè¯</h4>
        <textarea id="set_bad"></textarea>
        <button class="save-btn" onclick="saveBadWords()">ä¿å­˜</button>
      </div>
      <div class="section">
        <h4>ä¿®æ”¹å¯†ç </h4>
        <input id="new_pwd">
        <button class="save-btn" onclick="saveNewPwd()">ä¿å­˜</button>
      </div>
      <div class="section">
        <h4>æ‹‰é»‘åˆ—è¡¨</h4>
        <div id="blackList"></div>
      </div>
    </div>
  </div>
</div>

<script>
// ====================== é…ç½® ======================
const USER = "linshanghui";
const REPO = "lahz-grjs";
const TOKEN = "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";

const FILE_DATA  = "msg_data.json";
const FILE_CONF  = "msg_config.json";
const FILE_BLACK = "msg_black.json";

// å®˜æ–¹ QQ å¤´åƒæ¥å£ï¼ˆè…¾è®¯å®˜æ–¹ï¼‰
function getQQAvatar(qq) {
  return `https://q.qlogo.cn/headimg_dl?dst_uin=${qq}&spec=100`;
}

// è·å–å…¬ç½‘IPï¼ˆçœŸå®ã€å¯ä¿å­˜ï¼‰
async function getPublicIP() {
  try {
    const r = await fetch("https://api.ipify.org?format=json");
    const d = await r.json();
    return d.ip || "127.0.0.1";
  } catch (e) {
    return "127.0.0.1";
  }
}

// è¯»å†™ GitHub
async function load(file) {
  try {
    const r = await fetch(`https://raw.githubusercontent.com/${USER}/${REPO}/main/${file}`);
    return await r.json();
  } catch { return [] }
}

async function save(file, data) {
  try {
    const info = await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/${file}`);
    const json = await info.json();
    const str = JSON.stringify(data, null, 2);
    const base64 = btoa(unescape(encodeURIComponent(str)));
    await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/${file}`, {
      method: "PUT",
      headers: { Authorization: `token ${TOKEN}`, "Content-Type": "application/json" },
      body: JSON.stringify({ message: "update", content: base64, sha: json.sha })
    });
    return true;
  } catch { return false }
}

// æ•°æ®
let adminPwd = "123456";
let msgList = [], config = {}, blackList = [];
let pushConfig = { content: "", hour: 22, min: 23 };
let lastPost = 0, isLogin = false, currentNick = "";
let dailyTimer = null, editIndex = -1;

const tagColors = ["#13c2c2","#722ed1","#eb2f96","#1890ff","#52c41a","#faad14","#f5222d","#fa8c16"];

// ç»Ÿä¸€ä¿å­˜
const saveMsg = () => save(FILE_DATA, msgList);
const saveCfg = () => save(FILE_CONF, config);
const saveBlk = () => save(FILE_BLACK, blackList);

// åŠ è½½
async function loadAll() {
  msgList = await load(FILE_DATA);
  config = await load(FILE_CONF);
  blackList = await load(FILE_BLACK);

  if (!config?.minWords) {
    config = { minWords:5, maxWords:200, nickMaxWords:20, cooldown:30, badWords:"", pushTitle:"ç•™è¨€å¢™" };
    await saveCfg();
  }
  renderAll();
  refreshTips();
}

// å·¥å…·
function colorHash(s) {
  let h = 0;
  for (let i=0;i<s.length;i++) h = s.charCodeAt(i) + ((h<<5)-h);
  return tagColors[Math.abs(h)%tagColors.length];
}

function refreshTips() {
  document.getElementById("nickWordTip").textContent = `æ˜µç§°ï¼š0/${config.nickMaxWords}`;
  document.getElementById("contentWordTip").textContent = `å†…å®¹ï¼š0/${config.maxWords}`;
}

// QQ æ˜µç§°
let qTimer;
document.getElementById("qq").addEventListener("input", function() {
  clearTimeout(qTimer);
  const v = this.value.trim();
  if (v.length < 5) {
    document.getElementById("nickPreview").style.display = "none";
    return;
  }
  qTimer = setTimeout(async () => {
    document.getElementById("nickPreview").style.display = "block";
    document.getElementById("nickPreview").textContent = "è·å–ä¸­...";
    try {
      const r = await fetch(`https://api.uomg.com/api/qq.info?qq=${v}`);
      const d = await r.json();
      currentNick = d.name || "QQç”¨æˆ·";
      document.getElementById("nickPreview").textContent = "æ˜µç§°ï¼š" + currentNick;
    } catch {
      currentNick = "QQç”¨æˆ·";
      document.getElementById("nickPreview").textContent = "æ˜µç§°ï¼šQQç”¨æˆ·";
    }
  }, 600);
});

// å‘å¸ƒ
async function postMsg() {
  const qq = document.getElementById("qq").value.trim();
  const content = document.getElementById("content").value.trim();
  const now = Date.now()/1000|0;

  if (!qq) return alert("è¾“å…¥QQ");
  if (!content) return alert("è¾“å…¥å†…å®¹");
  if (now - lastPost < config.cooldown) return alert("å†·å´ä¸­");

  const ip = await getPublicIP();
  if (blackList.some(x => x.qq == qq || x.ip == ip)) return alert("å·²æ‹‰é»‘");

  const msg = {
    qq,
    name: currentNick || "QQç”¨æˆ·",
    avatar: getQQAvatar(qq),  // å®˜æ–¹å¤´åƒ
    content,
    time: new Date().toLocaleString(),
    ip,                         // çœŸå®IP
    isTop: false,
    tagsObj: []
  };

  msgList.unshift(msg);
  await saveMsg();
  lastPost = now;
  document.getElementById("content").value = "";
  renderMsg();
  alert("å‘å¸ƒæˆåŠŸï¼");
}

// æ¸²æŸ“
function renderMsg() {
  const w = document.getElementById("msgWall");
  w.innerHTML = "";
  const list = msgList.filter(x => !blackList.some(b => b.qq == x.qq || b.ip == x.ip));
  list.sort((a,b) => b.isTop - a.isTop);
  if (!list.length) {
    w.innerHTML = `<div style="text-align:center;padding:30px;color:#999">æš‚æ— ç•™è¨€</div>`;
    return;
  }
  list.forEach(item => {
    const i = msgList.findIndex(x => x.time == item.time && x.qq == item.qq);
    const top = item.isTop ? `<span class="top-tag">ç½®é¡¶</span>` : "";
    const tags = (item.tagsObj||[]).map(t => `<span class="tag-item" style="background:${t.color}">${t.text}</span>`).join("");
    const el = document.createElement("div");
    el.className = "message-item" + (item.isTop ? " top" : "");
    el.innerHTML = `
      <div class="admin-actions" id="act_${i}">
        <button class="act-del">åˆ </button>
        <button class="act-block">é»‘</button>
        <button class="act-top">é¡¶</button>
        <button class="act-edit">ç¼–</button>
      </div>
      <img src="${item.avatar}" class="avatar">
      <div class="msg-right">
        <div class="name">${item.name} ${top} ${tags}</div>
        <div class="content">${item.content}</div>
        <div class="qq-time-ip">QQ:${item.qq} ${item.time} IP:${item.ip}</div>
      </div>`;
    w.appendChild(el);
    if (isLogin) {
      const a = document.getElementById(`act_${i}`);
      a.style.display = "flex";
      a.querySelector(".act-del").onclick = () => { msgList.splice(i,1); saveMsg(); renderMsg() };
      a.querySelector(".act-block").onclick = () => { blackList.push({qq:item.qq,ip:item.ip}); saveBlk(); renderAll() };
      a.querySelector(".act-top").onclick = () => { item.isTop = !item.isTop; saveMsg(); renderMsg() };
      a.querySelector(".act-edit").onclick = () => {
        editIndex = i;
        document.getElementById("edit_name").value = item.name || "";
        document.getElementById("edit_qq").value = item.qq || "";
        document.getElementById("edit_time").value = item.time || "";
        document.getElementById("edit_ip").value = item.ip || "";
        document.getElementById("edit_content").value = item.content || "";
        document.getElementById("editModal").style.display = "flex";
      };
    }
  });
}

function renderBlack() {
  const b = document.getElementById("blackList");
  b.innerHTML = "";
  blackList.forEach((item,i) => {
    const d = document.createElement("div");
    d.className = "black-item";
    d.innerHTML = `<span>QQ:${item.qq} IP:${item.ip}</span><button class="unblock" onclick="unblock(${i})">è§£ç¦</button>`;
    b.appendChild(d);
  });
}

function unblock(i) {
  blackList.splice(i,1);
  saveBlk();
  renderAll();
}

function renderAll() { renderMsg(); renderBlack(); }
function closeEdit() { document.getElementById("editModal").style.display = "none"; }

async function saveEdit() {
  const i = editIndex;
  if (i < 0) return;
  msgList[i].name = document.getElementById("edit_name").value.trim();
  msgList[i].qq = document.getElementById("edit_qq").value.trim();
  msgList[i].time = document.getElementById("edit_time").value.trim();
  msgList[i].ip = document.getElementById("edit_ip").value.trim();
  msgList[i].content = document.getElementById("edit_content").value.trim();
  msgList[i].avatar = getQQAvatar(msgList[i].qq);
  await saveMsg();
  closeEdit();
  renderMsg();
  alert("ä¿å­˜æˆåŠŸ");
}

function openBackend() {
  if (!isLogin) {
    const p = prompt("å¯†ç ï¼š");
    if (p !== adminPwd) return alert("é”™è¯¯");
    isLogin = true;
    document.getElementById("logoutBtn").style.display = "inline-block";
  }
  document.getElementById("backendModal").style.display = "flex";
}

function closeBackend() { document.getElementById("backendModal").style.display = "none"; }
function logoutAdmin() { isLogin = false; document.getElementById("logoutBtn").style.display = "none"; closeBackend(); }

async function saveSetting() {
  config.minWords = +document.getElementById("set_min").value || 5;
  config.maxWords = +document.getElementById("set_max").value || 200;
  config.nickMaxWords = +document.getElementById("set_nick_max").value || 20;
  config.cooldown = +document.getElementById("set_cd").value || 30;
  config.pushTitle = document.getElementById("set_push_title").value.trim() || "ç•™è¨€å¢™";
  await saveCfg();
  alert("ä¿å­˜æˆåŠŸ");
}

async function saveBadWords() {
  config.badWords = document.getElementById("set_bad").value;
  await saveCfg();
  alert("ä¿å­˜æˆåŠŸ");
}

function saveNewPwd() {
  const v = document.getElementById("new_pwd").value.trim();
  if (!v) return alert("è¾“å…¥å¯†ç ");
  adminPwd = v;
  alert("ä¿®æ”¹æˆåŠŸ");
}

// æ¨é€å¿½ç•¥
async function manualPush() {}
function savePushConfigOnly() {}
function startDailyPush() {}
function stopDailyPush() {}
async function checkUrlPush() {}

loadAll();
</script>
</body>
</html>
