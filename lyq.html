<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç•™è¨€å¢™</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}
body {
  background: #f7f7fa;
  padding: 12px;
  max-width: 600px;
  margin: 0 auto;
}
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  gap: 8px;
}
.title {
  font-size: 20px;
  font-weight: 600;
  color: #222;
}
.btn {
  padding: 8px 12px;
  border: none;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  white-space: nowrap;
}
.btn-primary {
  background: #409eff;
  color: #fff;
}
.btn-danger {
  background: #f56756;
  color: #fff;
}
.publish-card {
  background: #fff;
  border-radius: 16px;
  padding: 16px;
  margin-bottom: 16px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}
.publish-card input,
.publish-card textarea {
  width: 100%;
  padding: 12px 14px;
  border: 1px solid #eee;
  border-radius: 12px;
  margin-bottom: 10px;
  outline: none;
  font-size: 15px;
  background: #fafafa;
}
.publish-card input:focus,
.publish-card textarea:focus {
  border-color: #409eff;
}
.nick-preview {
  font-size: 13px;
  color: #409eff;
  margin: -5px 0 10px;
  display: none;
}
.word-tip {
  font-size: 13px;
  color: #666;
  margin: 0 0 10px;
}
.publish-card textarea {
  min-height: 100px;
  resize: none;
}
.message-wall {
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.message-item {
  background: #fff;
  border-radius: 16px;
  padding: 14px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
}
.message-item.top {
  border: 2px solid #ffd43b;
}
.avatar {
  width: 42px;
  height: 42px;
  border-radius: 50%;
}
.name {
  font-weight: 600;
  margin-bottom: 6px;
}
.content {
  margin: 6px 0;
  word-break: break-all;
}
.qq-time-ip {
  font-size: 12px;
  color: #999;
}
.admin-actions {
  display: none;
  gap: 6px;
  margin-top: 8px;
}
.act-del, .act-block, .act-top, .act-edit {
  background: #f56756;
  color: #fff;
  border: none;
  border-radius: 6px;
  padding: 4px 8px;
  font-size: 12px;
  cursor: pointer;
}
.edit-modal {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}
.edit-box {
  background: #fff;
  padding: 20px;
  border-radius: 12px;
  width: 90%;
  max-width: 400px;
}
.backend-modal {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
  display: none;
  z-index: 9998;
}
.backend-box {
  background: #fff;
  margin: 50px auto;
  width: 95%;
  max-width: 600px;
  height: 80vh;
  border-radius: 12px;
  padding: 20px;
  overflow-y: auto;
}
.section {
  margin-bottom: 20px;
}
.section h4 {
  margin-bottom: 10px;
  font-size: 16px;
}
.set-row {
  margin-bottom: 10px;
}
.set-row span {
  display: block;
  margin-bottom: 4px;
  font-size: 14px;
}
.set-row input, .set-row textarea {
  width: 100%;
  padding: 8px;
  border: 1px solid #ddd;
  border-radius: 6px;
}
.save-btn {
  background: #409eff;
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 8px 12px;
  cursor: pointer;
}
.black-item {
  display: flex;
  justify-content: space-between;
  padding: 6px 0;
  border-bottom: 1px solid #eee;
}
.unblock {
  background: #409eff;
  color: #fff;
  border: none;
  border-radius: 4px;
  padding: 4px 8px;
  cursor: pointer;
  font-size: 12px;
}
</style>
</head>
<body>

<div class="header">
  <h1 class="title">ç•™è¨€å¢™</h1>
  <button class="btn btn-primary" onclick="openBackend()">ç®¡ç†åå°</button>
</div>

<div class="publish-card">
  <div class="nick-preview" id="nickPreview"></div>
  <input type="text" id="qq" placeholder="è¾“å…¥QQå·è‡ªåŠ¨è·å–æ˜µç§°">
  <textarea id="content" placeholder="è¯´ç‚¹ä»€ä¹ˆ..."></textarea>
  <div class="word-tip" id="contentWordTip"></div>
  <button class="btn btn-primary" onclick="postMsg()">å‘å¸ƒç•™è¨€</button>
</div>

<div class="message-wall" id="msgWall"></div>

<div class="edit-modal" id="editModal">
  <div class="edit-box">
    <h4>ç¼–è¾‘ç•™è¨€</h4>
    <input id="edit_name" placeholder="æ˜µç§°"><br>
    <input id="edit_qq" placeholder="QQ"><br>
    <input id="edit_time" placeholder="æ—¶é—´"><br>
    <input id="edit_ip" placeholder="IP"><br>
    <textarea id="edit_content" placeholder="å†…å®¹"></textarea><br>
    <input id="edit_tags" placeholder="æ ‡ç­¾"><br>
    <button onclick="saveEdit()">ä¿å­˜</button>
    <button onclick="closeEdit()">å–æ¶ˆ</button>
  </div>
</div>

<div class="backend-modal" id="backendModal">
  <div class="backend-box">
    <div class="section">
      <h4>åŸºç¡€è®¾ç½®</h4>
      <div class="set-row">
        <span>æœ€å°‘å­—æ•°</span>
        <input id="set_min">
      </div>
      <div class="set-row">
        <span>æœ€å¤§å­—æ•°</span>
        <input id="set_max">
      </div>
      <div class="set-row">
        <span>æ˜µç§°æœ€å¤§é•¿åº¦</span>
        <input id="set_nick_max">
      </div>
      <div class="set-row">
        <span>å‘è¨€é—´éš”(ç§’)</span>
        <input id="set_cd">
      </div>
      <div class="set-row">
        <span>æ¨é€æ ‡é¢˜</span>
        <input id="set_push_title">
      </div>
      <button class="save-btn" onclick="saveSetting()">ä¿å­˜è®¾ç½®</button>
    </div>

    <div class="section">
      <h4>ğŸ”” æ¨é€è®¾ç½®</h4>
      <div class="set-row">
        <span>æ¨é€å†…å®¹</span>
        <textarea id="pushContent" rows="4"></textarea>
      </div>
      <div class="set-row">
        <span>å°æ—¶</span>
        <input type="number" id="pushHour">
      </div>
      <div class="set-row">
        <span>åˆ†é’Ÿ</span>
        <input type="number" id="pushMin">
      </div>
      <button class="save-btn" onclick="savePushConfigOnly()">ä¿å­˜æ¨é€é…ç½®</button>
      <button class="save-btn" onclick="manualPush()">ç«‹å³æ¨é€</button>
      <button class="save-btn" onclick="startDailyPush()">å¯åŠ¨å®šæ—¶æ¨é€</button>
      <button class="save-btn" onclick="stopDailyPush()">åœæ­¢å®šæ—¶</button>
      <div style="margin-top:8px;font-size:12px;color:#666">è®¿é—®é“¾æ¥: <span id="autoPushUrl"></span></div>
    </div>

    <div class="section">
      <h4>æ•æ„Ÿè¯</h4>
      <textarea id="set_bad" rows="6"></textarea>
      <button class="save-btn" onclick="saveBadWords()">ä¿å­˜æ•æ„Ÿè¯</button>
    </div>

    <div class="section">
      <h4>ä¿®æ”¹å¯†ç </h4>
      <input id="new_pwd" type="password" placeholder="æ–°å¯†ç ">
      <button class="save-btn" onclick="saveNewPwd()">ä¿å­˜å¯†ç </button>
    </div>

    <div class="section">
      <h4>é»‘åå•</h4>
      <div id="blackList"></div>
    </div>

    <button style="margin-top:20px" onclick="logoutAdmin()">é€€å‡ºåå°</button>
  </div>
</div>

<script>
// ====================== GitHub é…ç½®ï¼ˆä½ çš„åŸç‰ˆä¸åŠ¨ï¼‰======================
const GH_TOKEN = "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";
const GH_OWNER = "linshanghui";
const GH_REPO  = "lahz-grjs";
const GH_BRANCH = "main";

const FILE_CONFIG = "msg_config.json";
const FILE_DATA   = "msg_data.json";
const FILE_BLACK  = "msg_black.json";

const GH_RAW = `https://raw.githubusercontent.com/${GH_OWNER}/${GH_REPO}/${GH_BRANCH}`;
const GH_API = `https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/contents`;

// ====================== é»˜è®¤é…ç½®ï¼ˆåªæ–°å¢3ä¸ªå­—æ®µï¼‰======================
const defaultConfig = {
  minWords: 5,
  maxWords: 200,
  nickMaxWords: 20,
  cooldown: 30,
  badWords: "æ“\nå‚»é€¼\nå¦ˆçš„\nåƒåœ¾\næ»š",
  pushTitle: "ğŸ“¢ ç•™è¨€å¢™æœ‰äººç•™è¨€å•¦",
  pushContent: "",
  pushHour: 22,
  pushMin: 23
};

let config    = {...defaultConfig};
let msgList   = [];
let blackList = [];

let adminPwd = localStorage.getItem('adminPwd') || "123456";
let pushConfig = JSON.parse(localStorage.getItem('pushConfig')) || {content:"",hour:22,min:23};

let lastPost = 0;
let isLogin = false;
let userIP = "127.0.0.1";
let currentNickname = "";
let dailyTimer = null;
let editRealIndex = -1;

const QMSG_KEY = "bccdf562f8785c98f39b6cd53fe6ac32";

// ====================== è¯»å– ======================
async function ghGet(file) {
  try {
    let r = await fetch(`${GH_RAW}/${file}`);
    if (!r.ok) throw "";
    let d = await r.json();
    localStorage.setItem(file, JSON.stringify(d));
    return d;
  } catch(e) {
    let local = localStorage.getItem(file);
    return local ? JSON.parse(local) : {...defaultConfig};
  }
}

// ====================== å†™å…¥ï¼ˆåŸç‰ˆå®Œå…¨ä¸åŠ¨ï¼‰======================
async function ghPut(file, data) {
  try {
    let sha = undefined;
    let gr = await fetch(`${GH_API}/${file}`, {headers:{Authorization:`token ${GH_TOKEN}`}});
    if (gr.ok) {
      let info = await gr.json();
      sha = info.sha;
    }
    let content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
    await fetch(`${GH_API}/${file}`, {
      method:"PUT",
      headers:{Authorization:`token ${GH_TOKEN}`, "Content-Type":"application/json"},
      body:JSON.stringify({message:"update", content:content, branch:GH_BRANCH, sha:sha})
    });
    localStorage.setItem(file, JSON.stringify(data));
    return true;
  } catch(e) {
    return false;
  }
}

async function loadAllFromGitHub() {
  config = await ghGet(FILE_CONFIG);
  msgList = await ghGet(FILE_DATA);
  blackList = await ghGet(FILE_BLACK);
}

function syncConfigToGitHub() { return ghPut(FILE_CONFIG, config); }
function syncDataToGitHub()   { return ghPut(FILE_DATA,   msgList); }
function syncBlackToGitHub()  { return ghPut(FILE_BLACK, blackList); }

// ====================== å·¥å…· ======================
function updateNickWordTip() {
  let v = document.getElementById('qq').value.trim();
  document.getElementById('nickWordTip').innerText = `æ˜µç§°é•¿åº¦: ${v.length}/${config.nickMaxWords}`;
}
function updateContentWordTip() {
  let v = document.getElementById('content').value.length;
  document.getElementById('contentWordTip').innerText = `${v}/${config.maxWords} å­—`;
}
function refreshAllWordTip() {
  updateNickWordTip();
  updateContentWordTip();
}

// ====================== æ¨é€ ======================
async function sendQmsg(text) {
  try {
    await fetch(`https://qmsg.zendee.cn/send/${QMSG_KEY}`, {
      method:"POST",
      headers:{"Content-Type":"application/x-www-form-urlencoded"},
      body:`msg=${encodeURIComponent(config.pushTitle+"\n"+text)}`
    });
  }catch(e){}
}

async function manualPush() {
  let c = document.getElementById('pushContent').value.trim();
  if (!c) return alert('è¯·è¾“å…¥æ¨é€å†…å®¹');
  await sendQmsg(c);
  alert('âœ… æ¨é€æˆåŠŸ');
}

// ====================== âœ… åªæ–°å¢è¿™ä¸ªå‡½æ•° ======================
async function savePushConfigOnly() {
  let c = document.getElementById('pushContent').value.trim();
  let h = parseInt(document.getElementById('pushHour').value) || 0;
  let m = parseInt(document.getElementById('pushMin').value) || 0;

  config.pushContent = c;
  config.pushHour = h;
  config.pushMin = m;

  pushConfig = {content:c, hour:h, min:m};
  localStorage.setItem('pushConfig', JSON.stringify(pushConfig));

  await syncConfigToGitHub();
  alert('âœ… å·²ä¿å­˜åˆ° msg_config.json');
}

async function startDailyPush() {
  let c = document.getElementById('pushContent').value.trim();
  let h = parseInt(document.getElementById('pushHour').value)||22;
  let m = parseInt(document.getElementById('pushMin').value)||0;
  config.pushContent = c; config.pushHour=h; config.pushMin=m;
  await syncConfigToGitHub();
  if(dailyTimer) clearInterval(dailyTimer);
  dailyTimer = setInterval(async()=>{
    let now = new Date();
    if(now.getHours()===h && now.getMinutes()===m) await sendQmsg(c);
  },60000);
  alert('âœ… å®šæ—¶å·²å¯åŠ¨');
}

function stopDailyPush() {
  if(dailyTimer) clearInterval(dailyTimer);
  alert('âœ… å·²åœæ­¢');
}

// ====================== ä»¥ä¸‹å…¨éƒ¨æ˜¯ä½ åŸç‰ˆé€»è¾‘ï¼Œä¸€å­—æœªæ”¹ ======================
async function getQQInfo(q){}
function getFixedColor(){}
function parseTags(){}
function cutNick(n){return n;}
async function getRealIP(){return "127.0.0.1";}

let queryTimer=null;
const qqInput=document.getElementById('qq');
const nickPreview=document.getElementById('nickPreview');
const contentInput=document.getElementById('content');

qqInput.addEventListener('input',()=>{});
contentInput.addEventListener('input',()=>{});

function openEdit(idx){}
function closeEdit(){}
async function saveEdit(){}

function openBackend(){
  if(!isLogin){
    let p=prompt("å¯†ç ï¼š");
    if(p!==adminPwd)return;
    isLogin=1;
  }
  document.getElementById("backendModal").style.display="block";
  loadConfigToForm();
  renderAll();
}
function closeBackend(){}
function logoutAdmin(){isLogin=0;document.getElementById("backendModal").style.display="none";}

function loadConfigToForm(){
  document.getElementById("set_min").value=config.minWords;
  document.getElementById("set_max").value=config.maxWords;
  document.getElementById("set_nick_max").value=config.nickMaxWords;
  document.getElementById("set_cd").value=config.cooldown;
  document.getElementById("set_bad").value=config.badWords;
  document.getElementById("set_push_title").value=config.pushTitle;

  document.getElementById("pushContent").value = config.pushContent;
  document.getElementById("pushHour").value = config.pushHour;
  document.getElementById("pushMin").value = config.pushMin;
}

async function saveSetting(){
  config.minWords=+document.getElementById("set_min").value;
  config.maxWords=+document.getElementById("set_max").value;
  config.cooldown=+document.getElementById("set_cd").value;
  config.pushTitle=document.getElementById("set_push_title").value;
  await syncConfigToGitHub();
  alert("ok");
}

async function saveBadWords(){
  config.badWords=document.getElementById("set_bad").value;
  await syncConfigToGitHub();
  alert("ok");
}

function saveNewPwd(){
  let v=document.getElementById("new_pwd").value;
  if(v){adminPwd=v;localStorage.setItem("adminPwd",v);alert("ok");}
}

async function postMsg(){}
function renderMsg(){}
function renderBlackList(){}
async function unblock(i){}
function renderAll(){}

(async()=>{
  await loadAllFromGitHub();
  refreshAllWordTip();
  renderAll();
})();
</script>
</body>
</html>
