<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç•™è¨€å¢™</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}
body {
  background: #f7f7fa;
  padding: 12px;
  max-width: 600px;
  margin: 0 auto;
}
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  gap: 8px;
}
.title {
  font-size: 20px;
  font-weight: 600;
  color: #222;
}
.btn {
  padding: 8px 12px;
  border: none;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  white-space: nowrap;
}
.btn-primary {
  background: #409eff;
  color: #fff;
}
.btn-danger {
  background: #f56756;
  color: #fff;
}

.publish-card {
  background: #fff;
  border-radius: 16px;
  padding: 16px;
  margin-bottom: 16px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}
.publish-card input,
.publish-card textarea {
  width: 100%;
  padding: 12px 14px;
  border: 1px solid #eee;
  border-radius: 12px;
  margin-bottom: 10px;
  outline: none;
  font-size: 15px;
  background: #fafafa;
  transition: border 0.2s;
}
.publish-card input:focus,.publish-card textarea:focus {
  border-color: #409eff;
}
.nick-preview {
  font-size: 13px;
  color: #409eff;
  margin: -5px 0 10px;
  display: none;
}
.word-tip {
  font-size: 13px;
  color: #666;
  margin: 0 0 10px;
}
.publish-card textarea {
  min-height: 100px;
  resize: none;
}
.publish-card button {
  width: 100%;
  padding: 12px;
  background: #409eff;
  color: #fff;
  border: none;
  border-radius: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: opacity 0.2s;
}
.publish-card button:hover {
  opacity: 0.9;
}

.message-wall {
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.message-item {
  background: #fff;
  border-radius: 16px;
  padding: 14px;
  position: relative;
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  display: flex;
  gap: 12px;
}
.message-item.top {
  border: 1px solid #ffd43b;
  background: #fffdf5;
}
.avatar {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  object-fit: cover;
  background: #eee;
  flex-shrink: 0;
}
.msg-right {
  flex: 1;
}
.name {
  font-weight: 600;
  font-size: 15px;
  color: #222;
  margin-bottom: 6px;
  display: flex;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
}
.top-tag {
  background: #FF7D00;
  color: #fff;
  font-size: 11px;
  padding: 2px 6px;
  border-radius: 4px;
  font-weight: bold;
}
.tag-item {
  font-size: 11px;
  padding: 2px 6px;
  border-radius: 4px;
  font-weight: bold;
  color: #fff;
}
.content {
  font-size: 15px;
  line-height: 1.5;
  color: #333;
  word-break: break-all;
}
.qq-time-ip {
  font-size: 12px;
  color: #999;
  display: flex;
  gap: 8px;
  align-items: center;
  flex-wrap: wrap;
  margin-top: 8px;
}
.admin-actions {
  position: absolute;
  top: 10px;
  right: 10px;
  display: none;
  gap: 4px;
}
.act-del { background: #f56756; width: 26px; height: 22px; font-size: 10px; border: none; border-radius: 4px; color: #fff; cursor: pointer; }
.act-block { background: #ff9f43; width: 26px; height: 22px; font-size: 10px; border: none; border-radius: 4px; color: #fff; cursor: pointer; }
.act-top { background: #409eff; width: 26px; height: 22px; font-size: 10px; border: none; border-radius: 4px; color: #fff; cursor: pointer; }
.act-edit { background: #722ed1; width: 26px; height: 22px; font-size: 10px; border: none; border-radius: 4px; color: #fff; cursor: pointer; }
</style>
</head>
<body>

<div class="header">
  <div class="title">ğŸ’¬ ç•™è¨€å¢™</div>
  <div>
    <button class="btn btn-primary" onclick="openBackend()">ç®¡ç†</button>
    <button class="btn btn-danger" id="logoutBtn" style="display:none;margin-left:6px" onclick="logoutAdmin()">é€€å‡º</button>
  </div>
</div>

<div class="publish-card">
  <input id="qq" placeholder="è¯·è¾“å…¥QQå·" autocomplete="off">
  <div class="nick-preview" id="nickPreview"></div>
  <div class="word-tip" id="nickWordTip"></div>
  <textarea id="content" placeholder="æƒ³è¯´ç‚¹ä»€ä¹ˆ..."></textarea>
  <div class="word-tip" id="contentWordTip"></div>
  <button onclick="postMsg()">å‘å¸ƒç•™è¨€</button>
</div>

<div class="message-wall" id="msgWall"></div>

<script>
// ====================== GitHub äº‘ç«¯ä¸‰æ–‡ä»¶å­˜å‚¨ ======================
const USER = "linshanghui";
const REPO = "lahz-grjs";
const TOKEN = "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";

const FILES = {
  data: "msg_data.json",
  config: "msg_config.json",
  black: "msg_black.json"
};

// å·¥å…·
async function getFile(file) {
  const r = await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/${file}`);
  return await r.json();
}
async function putFile(file, data) {
  const old = await getFile(file);
  const str = JSON.stringify(data, null, 2);
  const base64 = btoa(unescape(encodeURIComponent(str)));
  await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/${file}`, {
    method: "PUT",
    headers: { Authorization: `token ${TOKEN}`, "Content-Type": "application/json" },
    body: JSON.stringify({ message: "æ›´æ–°", content: base64, sha: old.sha })
  });
}

// å…¨å±€æ•°æ®
let msgList = [];
let config = { minWords:5, maxWords:200, cooldown:10 };
let blackList = [];
let adminPwd = "123456";
let isLogin = false;
let lastPost = 0;

// åˆå§‹åŒ–åŠ è½½å…¨éƒ¨
async function loadAll() {
  try {
    msgList = await (await fetch(`https://raw.githubusercontent.com/${USER}/${REPO}/main/${FILES.data}`)).json();
  } catch (e) { msgList = []; }
  try {
    config = await (await fetch(`https://raw.githubusercontent.com/${USER}/${REPO}/main/${FILES.config}`)).json();
  } catch (e) { config = { minWords:5, maxWords:200, cooldown:10 }; }
  try {
    blackList = await (await fetch(`https://raw.githubusercontent.com/${USER}/${REPO}/main/${FILES.black}`)).json();
  } catch (e) { blackList = []; }
  renderMsg();
}

// æ¸²æŸ“
function renderMsg() {
  const wall = document.getElementById("msgWall");
  wall.innerHTML = "";
  const show = msgList.filter(m => !blackList.some(b => b.qq == m.qq));
  if (show.length === 0) {
    wall.innerHTML = "<div style='text-align:center;padding:40px;color:#999'>æš‚æ— ç•™è¨€</div>";
    return;
  }
  show.forEach(item => {
    const div = document.createElement("div");
    div.className = "message-item";
    div.innerHTML = `
      <img class="avatar" src="https://q.qlogo.cn/headimg_dl?dst_uin=${item.qq}&spec=100">
      <div class="msg-right">
        <div class="name">${item.name || "ç½‘å‹"}</div>
        <div class="content">${item.content}</div>
        <div class="qq-time-ip">QQ: ${item.qq} | ${item.time}</div>
      </div>
    `;
    wall.appendChild(div);
  });
}

// å‘å¸ƒ
async function postMsg() {
  const qq = document.getElementById("qq").value.trim();
  const content = document.getElementById("content").value.trim();
  if (!qq || !content) return alert("è¯·å¡«å†™å®Œæ•´");
  if (content.length < config.minWords) return alert(`æœ€å°‘${config.minWords}å­—`);
  if (content.length > config.maxWords) return alert(`æœ€å¤š${config.maxWords}å­—`);
  
  const now = Date.now();
  if (now - lastPost < config.cooldown * 1000) return alert("å‘è¨€è¿‡å¿«");
  
  // æ‹‰é»‘åˆ¤æ–­
  if (blackList.some(b => b.qq == qq)) return alert("ä½ å·²è¢«æ‹‰é»‘");

  lastPost = now;
  const newMsg = {
    qq,
    content,
    name: "ç½‘å‹",
    time: new Date().toLocaleString()
  };
  
  msgList.unshift(newMsg);
  await putFile(FILES.data, msgList);
  
  document.getElementById("content").value = "";
  alert("å‘å¸ƒæˆåŠŸï¼");
  renderMsg();
}

// ç®¡ç†
function openBackend() {
  const p = prompt("ç®¡ç†å¯†ç ï¼š");
  if (p === adminPwd) {
    isLogin = true;
    document.getElementById("logoutBtn").style.display = "inline-block";
    alert("ç™»å½•æˆåŠŸ");
  } else alert("å¯†ç é”™è¯¯");
}
function logoutAdmin() {
  isLogin = false;
  document.getElementById("logoutBtn").style.display = "none";
  alert("å·²é€€å‡º");
}

// å¯åŠ¨
loadAll();
</script>
</body>
</html>
