<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç•™è¨€å¢™</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}
body {
  background: #f7f7fa;
  padding: 12px;
  max-width: 600px;
  margin: 0 auto;
}
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}
.title {
  font-size: 20px;
  font-weight: 600;
}
.btn {
  padding: 8px 12px;
  border-radius: 8px;
  border: none;
  background: #409eff;
  color: #fff;
  cursor: pointer;
}
.btn-red {
  background: #f56565;
}
.card {
  background: #fff;
  padding: 16px;
  border-radius: 16px;
  margin-bottom: 16px;
}
input, textarea {
  width: 100%;
  padding: 12px;
  border: 1px solid #eee;
  border-radius: 12px;
  margin: 8px 0;
  font-size: 14px;
}
button {
  width: 100%;
  padding: 12px;
  background: #409eff;
  color: #fff;
  border: none;
  border-radius: 12px;
  font-size: 15px;
  cursor: pointer;
}
.msg {
  background: #fff;
  padding: 14px;
  border-radius: 12px;
  margin-bottom: 12px;
  position: relative;
}
.msg-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
  float: left;
  margin-right: 12px;
}
.msg-content {
  overflow: hidden;
}
.msg-name {
  font-weight: 600;
  margin-bottom: 4px;
}
.msg-text {
  margin: 6px 0;
  line-height: 1.4;
}
.msg-info {
  font-size: 12px;
  color: #999;
}
.msg-admin {
  margin-top: 8px;
  display: flex;
  gap: 6px;
}
.msg-admin button {
  padding: 4px 8px;
  font-size: 12px;
  border-radius: 6px;
}
</style>
</head>
<body>

<div class="header">
  <div class="title">ğŸ’¬ ç•™è¨€å¢™</div>
  <div>
    <button class="btn" onclick="location.reload()">åˆ·æ–°</button>
  </div>
</div>

<div class="card">
  <input id="qq" placeholder="è¯·è¾“å…¥QQå·" autocomplete="off">
  <textarea id="content" rows="4" placeholder="æƒ³è¯´ç‚¹ä»€ä¹ˆ..."></textarea>
  <button onclick="postMsg()">å‘å¸ƒç•™è¨€</button>
</div>

<div id="msgList"></div>

<script>
// ===================== é…ç½®ä¿¡æ¯ =====================
const GH = {
  user: "linshanghui",
  repo: "lahz-grjs",
  token: atob("Z2hwX2xpSURUMUpITHFER1pJcFZZbW1qcU1BeW5RNHcyczBtNEJ2ZQ=="),
  branch: "main"
};

const ADMIN_PWD = "123456";
let isAdmin = false;
let msgList = [];

// ===================== GitHub è¯»å†™ =====================
async function ghGet(path) {
  try {
    const res = await fetch(`https://api.github.com/repos/${GH.user}/${GH.repo}/contents/${path}?ref=${GH.branch}`);
    const data = await res.json();
    return JSON.parse(atob(data.content));
  } catch (e) {
    return [];
  }
}

async function ghPut(path, data) {
  try {
    const url = `https://api.github.com/repos/${GH.user}/${GH.repo}/contents/${path}`;
    const headers = { Authorization: `token ${GH.token}` };
    const res = await fetch(url + "?ref=" + GH.branch);
    const json = await res.json();
    const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));

    await fetch(url, {
      method: "PUT",
      headers,
      body: JSON.stringify({
        message: "update",
        content: content,
        sha: json.sha,
        branch: GH.branch
      })
    });
    return true;
  } catch (e) {
    alert("ä¿å­˜å¤±è´¥");
    return false;
  }
}

// ===================== å·¥å…·å‡½æ•° =====================
function getAvatar(qq) {
  return `https://q.qlogo.cn/headimg_dl?dst_uin=${qq}&spec=100`;
}

// ===================== æ¸²æŸ“ =====================
function render() {
  const html = msgList.map((m, idx) => `
    <div class="msg">
      <img class="msg-avatar" src="${getAvatar(m.qq)}" alt="å¤´åƒ">
      <div class="msg-content">
        <div class="msg-name">${m.name}</div>
        <div class="msg-text">${m.content}</div>
        <div class="msg-info">QQ: ${m.qq} Â· ${m.time}</div>
        ${isAdmin ? `
        <div class="msg-admin">
          <button class="btn-red" onclick="delMsg(${idx})">åˆ é™¤</button>
        </div>
        ` : ""}
      </div>
    </div>
  `).join("");
  document.getElementById("msgList").innerHTML = html;
}

// ===================== å‘å¸ƒ =====================
async function postMsg() {
  const qq = document.getElementById("qq").value.trim();
  const content = document.getElementById("content").value.trim();
  if (!qq || !content) return alert("è¯·å¡«å†™å®Œæ•´");

  const msg = {
    qq,
    name: "ç½‘å‹",
    content,
    time: new Date().toLocaleString()
  };

  msgList.unshift(msg);
  await ghPut("data/messages.json", msgList);
  render();

  document.getElementById("qq").value = "";
  document.getElementById("content").value = "";
  alert("å‘å¸ƒæˆåŠŸï¼");
}

// ===================== ç®¡ç† =====================
function delMsg(index) {
  if (!confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) return;
  msgList.splice(index, 1);
  ghPut("data/messages.json", msgList);
  render();
}

// ===================== å¯åŠ¨ =====================
window.addEventListener("DOMContentLoaded", async () => {
  msgList = await ghGet("data/messages.json") || [];
  render();
});
</script>
</body>
</html>
