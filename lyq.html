<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç•™è¨€å¢™</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif; }
body { background:#f7f7fa; padding:12px; max-width:600px; margin:0 auto; }
.header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; gap:8px; }
.title { font-size:20px; font-weight:600; color:#222; }
.btn { padding:8px 12px; border:none; border-radius:10px; font-size:14px; font-weight:500; cursor:pointer; white-space:nowrap; }
.btn-primary { background:#409eff; color:#fff; }
.btn-danger { background:#f56756; color:#fff; }

.publish-card { background:#fff; border-radius:16px; padding:16px; margin-bottom:16px; box-shadow:0 2px 10px rgba(0,0,0,0.05); }
.publish-card input, .publish-card textarea { width:100%; padding:12px 14px; border:1px solid #eee; border-radius:12px; margin-bottom:10px; outline:none; font-size:15px; background:#fafafa; transition:border-color .2s; }
.publish-card input:focus, .publish-card textarea:focus { border-color:#409eff; }
.nick-preview { font-size:13px; color:#409eff; margin:-5px 0 10px; display:none; }
.word-tip { font-size:13px; color:#666; margin:0 0 10px; }
.publish-card textarea { min-height:100px; resize:none; }
.publish-card button { width:100%; padding:12px; background:#409eff; color:#fff; border:none; border-radius:12px; font-weight:500; cursor:pointer; }
.publish-card button:hover { opacity:.9; }

.message-wall { display:flex; flex-direction:column; gap:12px; }
.message-item { background:#fff; border-radius:16px; padding:14px; position:relative; box-shadow:0 2px 8px rgba(0,0,0,0.04); display:flex; gap:12px; }
.message-item.top { border:1px solid #ffd433; background:#fffdf5; }
.avatar { width:42px; height:42px; border-radius:50%; object-fit:cover; background:#eee; flex-shrink:0; }
.msg-right { flex:1; }
.name { font-weight:600; font-size:15px; color:#222; margin-bottom:6px; display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
.top-tag { background:#fa8c16; color:#fff; font-size:11px; padding:2px 6px; border-radius:4px; font-weight:bold; }
.tag-item { font-size:11px; padding:2px 6px; border-radius:4px; color:#fff; }
.content { font-size:15px; line-height:1.5; color:#333; word-break:break-all; }
.qq-time-ip { font-size:12px; color:#999; display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }

.admin-actions { position:absolute; top:10px; right:10px; display:none; gap:4px; }
.act-del { background:#f56756; width:26px; height:22px; font-size:10px; border:none; border-radius:4px; color:#fff; cursor:pointer; }
.act-block { background:#fa8c16; width:26px; height:22px; font-size:10px; border:none; border-radius:4px; color:#fff; cursor:pointer; }
.act-top { background:#409eff; width:26px; height:22px; font-size:10px; border:none; border-radius:4px; color:#fff; cursor:pointer; }
.act-edit { background:#722ed1; width:26px; height:22px; font-size:10px; border:none; border-radius:4px; color:#fff; cursor:pointer; }

.edit-modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.5); display:none; justify-content:center; align-items:center; z-index:99999; }
.edit-box { background:#fff; width:90%; max-width:400px; border-radius:16px; padding:20px; }
.edit-box h4 { margin-bottom:12px; font-size:16px; }
.edit-box input, .edit-box textarea { width:100%; padding:10px; margin-bottom:10px; border:1px solid #eee; border-radius:8px; outline:none; }
.edit-btns { display:flex; gap:10px; margin-top:10px; }
.edit-btns button { flex:1; padding:10px; border:none; border-radius:8px; cursor:pointer; }
.btn-save { background:#409eff; color:#fff; }
.btn-cancel { background:#f1f1f1; color:#333; }

.backend-modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.3); display:none; z-index:9999; }
.backend-box { background:#fff; width:100%; height:100%; display:flex; flex-direction:column; }
.backend-header { background:#409eff; color:#fff; padding:16px; display:flex; justify-content:space-between; align-items:center; }
.backend-close { background:none; border:none; color:#fff; font-size:20px; cursor:pointer; }
.backend-body { flex:1; padding:16px; overflow-y:auto; background:#f7f7fa; }
.section { background:#fff; border-radius:14px; padding:16px; margin-bottom:14px; }
.section h4 { margin-bottom:12px; font-size:16px; }
.set-row { display:flex; flex-direction:column; gap:6px; margin-bottom:12px; }
.set-row span { font-size:14px; color:#555; }
.set-row input { padding:10px 12px; border:1px solid #eee; border-radius:10px; font-size:15px; background:#fafafa; }
textarea { width:100%; height:100px; padding:12px; border:1px solid #eee; border-radius:10px; font-size:14px; background:#fafafa; resize:none; }
.save-btn { width:100%; padding:11px; background:#409eff; color:#fff; border:none; border-radius:10px; margin-top:6px; cursor:pointer; }
.black-item { display:flex; justify-content:space-between; align-items:center; padding:10px 12px; background:#fafafa; border-radius:10px; margin-bottom:8px; }
.unblock { background:#409eff; color:#fff; border:none; padding:5px 9px; border-radius:6px; font-size:12px; cursor:pointer; }
</style>
</head>
<body>

<div class="header">
  <div class="title">ğŸ’¬ ç•™è¨€å¢™</div>
  <div>
    <button class="btn btn-primary" onclick="openBackend()">ç®¡ç†</button>
    <button class="btn btn-danger" id="logoutBtn" style="display:none;margin-left:8px;" onclick="logoutAdmin()">é€€å‡º</button>
  </div>
</div>

<div class="publish-card">
  <input id="qq" placeholder="QQå·" autocomplete="off">
  <div class="nick-preview" id="nickPreview">åŠ è½½ä¸­...</div>
  <div class="word-tip" id="nickWordTip"></div>

  <textarea id="content" placeholder="æƒ³è¯´ç‚¹ä»€ä¹ˆ..."></textarea>
  <div class="word-tip" id="contentWordTip"></div>
  <button onclick="postMsg()">å‘å¸ƒç•™è¨€</button>
</div>

<div class="message-wall" id="msgWall"></div>

<div class="edit-modal" id="editModal">
  <div class="edit-box">
    <h4>ç¼–è¾‘ç•™è¨€</h4>
    <input id="edit_name" placeholder="æ˜µç§°">
    <input id="edit_qq" placeholder="QQ">
    <input id="edit_time" placeholder="æ—¶é—´">
    <input id="edit_ip" placeholder="IP">
    <textarea id="edit_content" rows="4" placeholder="å†…å®¹"></textarea>
    <input id="edit_tags" placeholder="æ ¼å¼ï¼šæç¬‘:#ff5722">
    <div class="edit-btns">
      <button class="btn-cancel" onclick="closeEdit()">å–æ¶ˆ</button>
      <button class="btn-save" onclick="saveEdit()">ä¿å­˜</button>
    </div>
  </div>
</div>

<div class="backend-modal" id="backendModal">
  <div class="backend-box">
    <div class="backend-header">
      <h3>ç®¡ç†åå°</h3>
      <button class="backend-close" onclick="closeBackend()">Ã—</button>
    </div>
    <div class="backend-body">
      <div class="section" style="background:#fff7e6;">
        <h4>ğŸ” ç äº‘ä»¤ç‰Œ</h4>
        <div class="set-row">
          <span>ç§äººä»¤ç‰Œï¼ˆåªå­˜æœ¬åœ°ï¼‰</span>
          <input type="password" id="gitee_token_input">
        </div>
        <button class="save-btn" style="background:#fa8c16;" onclick="saveGiteeTokenLocal()">ä¿å­˜ä»¤ç‰Œ</button>
      </div>

      <div class="section">
        <h4>åŸºç¡€è®¾ç½®</h4>
        <div class="set-row"><span>æœ€å°å­—æ•°</span><input id="set_min"></div>
        <div class="set-row"><span>æœ€å¤§å­—æ•°</span><input id="set_max"></div>
        <div class="set-row"><span>æ˜µç§°é•¿åº¦</span><input id="set_nick_max"></div>
        <div class="set-row"><span>å‘è¨€å†·å´</span><input id="set_cd"></div>
        <div class="set-row"><span>æ¨é€æ ‡é¢˜</span><input id="set_push_title"></div>
        <button class="save-btn" onclick="saveSetting()">ä¿å­˜è®¾ç½®</button>
      </div>

      <div class="section" style="background:#e6f7ff;">
        <h4>ğŸ”§ æ¨é€è®¾ç½®</h4>
        <div class="set-row">
          <span>æ¨é€å†…å®¹</span>
          <textarea id="pushContent"></textarea>
        </div>
        <div class="set-row">
          <button class="save-btn" style="background:#52c41a" onclick="manualPush()">ç«‹å³æ¨é€</button>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px;">
          <div style="flex:1;">
            <span>å°æ—¶</span>
            <input type="number" id="pushHour" min="0" max="23">
          </div>
          <div style="flex:1;">
            <span>åˆ†é’Ÿ</span>
            <input type="number" id="pushMin" min="0" max="59">
          </div>
        </div>
        <div style="display:flex;gap:6px;margin-top:8px;">
          <button class="save-btn" style="background:#ff9f43;flex:1" onclick="startDailyPush()">å¯åŠ¨å®šæ—¶</button>
          <button class="save-btn" style="background:#f56756;flex:1" onclick="stopDailyPush()">åœæ­¢å®šæ—¶</button>
        </div>
        <button class="save-btn" style="background:#722ed1;margin-top:8px;" onclick="savePushConfigOnly()">ä¿å­˜æ¨é€é…ç½®</button>
      </div>

      <div class="section">
        <h4>æ•æ„Ÿè¯</h4>
        <textarea id="set_bad"></textarea>
        <button class="save-btn" onclick="saveBadWords()">ä¿å­˜æ•æ„Ÿè¯</button>
      </div>

      <div class="section">
        <h4>ä¿®æ”¹å¯†ç </h4>
        <div class="set-row"><span>æ–°å¯†ç </span><input id="new_pwd"></div>
        <button class="save-btn" onclick="saveNewPwd()">ä¿å­˜å¯†ç </button>
      </div>

      <div class="section">
        <h4>é»‘åå•</h4>
        <div id="blackList"></div>
      </div>
    </div>
  </div>
</div>

<script>
// ====================== ç äº‘é…ç½® ======================
const GITEE_OWNER  = "linshanghui";
const GITEE_REPO   = "lahz-grjs";
const GITEE_BRANCH = "main";
const GITEE_API    = "https://gitee.com/api/v5";
const GITEE_RAW    = `https://gitee.com/${GITEE_OWNER}/${GITEE_REPO}/raw/${GITEE_BRANCH}`;

const FILE_CONFIG = "msg_config.json";
const FILE_DATA   = "msg_data.json";
const FILE_BLACK  = "msg_black.json";

const defaultConfig = {
  minWords: 5,
  maxWords: 200,
  nickMaxWords: 20,
  cooldown: 30,
  badWords: "æ“\nå‚»é€¼\nå¦ˆçš„\nåƒåœ¾\næ»š",
  pushTitle: "ç•™è¨€å¢™æœ‰äººç•™è¨€å•¦",
  pushConfig: { content: "", hour: 22, min: 23 }
};

let config      = {...defaultConfig};
let msgList     = [];
let blackList   = [];
let pushConfig  = {...defaultConfig.pushConfig};

let adminPwd    = localStorage.getItem('adminPwd') || "123456";
let lastPost    = 0;
let isLogin     = false;
let userIP      = "127.0.0.1";
let currentNick = "";
let dailyTimer  = null;
let editIndex   = -1;

const QMSG_KEY = "bccdf562f8785c98f39b6cd53fe6ac32";

// ====================== æœ¬åœ°ä»¤ç‰Œ ======================
function getGiteeToken() {
  return localStorage.getItem("gitee_token") || "";
}
function saveGiteeTokenLocal() {
  const t = document.getElementById("gitee_token_input").value.trim();
  if (!t) return alert("è¯·è¾“å…¥ä»¤ç‰Œ");
  localStorage.setItem("gitee_token", t);
  alert("âœ… ä»¤ç‰Œå·²ä¿å­˜");
}

// ====================== ä¸Šä¼ ç äº‘ ======================
function b64(str) {
  return btoa(unescape(encodeURIComponent(str)));
}

async function giteeUpload(path, content, msg) {
  const token = getGiteeToken();
  if (!token) return alert("è¯·å…ˆé…ç½®ä»¤ç‰Œ"), false;

  try {
    let sha = "";
    const getRes = await fetch(`${GITEE_API}/repos/${GITEE_OWNER}/${GITEE_REPO}/contents/${path}?access_token=${token}&ref=${GITEE_BRANCH}`);
    if (getRes.ok) {
      const data = await getRes.json();
      sha = data.sha;
    }

    const body = {
      access_token: token,
      content: b64(content),
      message: msg,
      branch: GITEE_BRANCH
    };
    if (sha) body.sha = sha;

    const res = await fetch(`${GITEE_API}/repos/${GITEE_OWNER}/${GITEE_REPO}/contents/${path}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    if (!res.ok) throw new Error("ä¸Šä¼ å¤±è´¥");
    alert("âœ… å·²åŒæ­¥åˆ°ç äº‘");
    return true;
  } catch (e) {
    alert("âŒ ä¸Šä¼ å¤±è´¥ï¼š" + e.message);
    return false;
  }
}

async function syncConfig() {
  // å…³é”®ï¼šæŠŠå½“å‰ pushConfig å†™è¿› config å†ä¸Šä¼ 
  config.pushConfig = pushConfig;
  await giteeUpload(FILE_CONFIG, JSON.stringify(config, null, 2), "æ›´æ–°é…ç½®");
}
async function syncData()  { await giteeUpload(FILE_DATA,  JSON.stringify(msgList, null, 2), "æ›´æ–°ç•™è¨€"); }
async function syncBlack() { await giteeUpload(FILE_BLACK, JSON.stringify(blackList, null, 2), "æ›´æ–°é»‘åå•"); }

// ====================== ä»ç äº‘æ‹‰å–ï¼ˆä¿®å¤ç‚¹1ï¼‰ ======================
async function loadFromGitee() {
  try {
    // å¼ºåˆ¶ä»çº¿ä¸Šæ‹‰ï¼Œä¸è¯»æœ¬åœ°ç¼“å­˜
    const confRes = await fetch(`${GITEE_RAW}/${FILE_CONFIG}?t=${Date.now()}`);
    if (confRes.ok) config = await confRes.json();

    const msgRes = await fetch(`${GITEE_RAW}/${FILE_DATA}?t=${Date.now()}`);
    if (msgRes.ok) msgList = await msgRes.json();

    const blackRes = await fetch(`${GITEE_RAW}/${FILE_BLACK}?t=${Date.now()}`);
    if (blackRes.ok) blackList = await blackRes.json();

  } catch (e) {
    console.log("ä½¿ç”¨æœ¬åœ°é…ç½®");
  }

  // ä»ç äº‘é…ç½®é‡Œæ¢å¤æ¨é€ï¼ˆä¿®å¤ç‚¹2ï¼‰
  if (config.pushConfig) {
    pushConfig = config.pushConfig;
  }
}

// ====================== æ¨é€ï¼ˆä¿®å¤ç‚¹3ï¼šæ°¸è¿œç”¨æœ€æ–°è¾“å…¥æ¡†å†…å®¹ï¼‰ ======================
async function sendQmsg(text) {
  try {
    const title = config.pushTitle || "ç•™è¨€å¢™é€šçŸ¥";
    await fetch(`https://qmsg.zendee.cn/send/${QMSG_KEY}`, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: `msg=${encodeURIComponent(title + "\n" + text)}`
    });
  } catch (e) {}
}

async function manualPush() {
  // ç›´æ¥è¯»è¾“å…¥æ¡†ï¼Œä¸è¯»ç¼“å­˜
  const text = document.getElementById("pushContent").value.trim();
  if (!text) return alert("è¯·è¾“å…¥æ¨é€å†…å®¹");
  await sendQmsg(text);
  alert("âœ… æ¨é€æˆåŠŸ");
}

function savePushConfigOnly() {
  // ä»è¾“å…¥æ¡†ä¿å­˜åˆ° pushConfig
  pushConfig.content = document.getElementById("pushContent").value.trim();
  pushConfig.hour    = parseInt(document.getElementById("pushHour").value) || 0;
  pushConfig.min     = parseInt(document.getElementById("pushMin").value) || 0;
  syncConfig();
}

function startDailyPush() {
  savePushConfigOnly();
  if (dailyTimer) clearTimeout(dailyTimer);
  if (!pushConfig.content) return alert("è¯·å¡«å†™æ¨é€å†…å®¹");

  function next() {
    const now = new Date();
    const tar = new Date();
    tar.setHours(pushConfig.hour, pushConfig.min, 0, 0);
    if (tar <= now) tar.setDate(tar.getDate() + 1);
    return tar - now;
  }
  async function task() {
    await sendQmsg(pushConfig.content);
    schedule();
  }
  function schedule() {
    dailyTimer = setTimeout(task, next());
  }
  schedule();
  alert("âœ… å®šæ—¶æ¨é€å·²å¯åŠ¨");
}

function stopDailyPush() {
  if (dailyTimer) clearTimeout(dailyTimer);
  dailyTimer = null;
  alert("âœ… å·²åœæ­¢");
}

// ====================== å·¥å…· ======================
function cutStr(s) {
  return s.length > config.nickMaxWords ? s.slice(0, config.nickMaxWords) + "..." : s;
}
function refreshTips() {
  const q = document.getElementById("qq").value.length;
  const c = document.getElementById("content").value.length;
  document.getElementById("nickWordTip").innerText = `QQ: ${q}/${config.nickMaxWords}`;
  document.getElementById("contentWordTip").innerText = `å†…å®¹: ${c}/${config.maxWords}`;
}

async function getRealIP() {
  try {
    return new Promise(res => {
      const pc = new RTCPeerConnection({iceServers:[]});
      const set = new Set();
      pc.createDataChannel("");
      pc.onicecandidate = e => {
        if (!e.candidate) {
          const arr = Array.from(set);
          const local = arr.find(i=>i.startsWith("192.168.")||i.startsWith("10.")||i.startsWith("172."));
          return res(local || arr[0] || "127.0.0.1");
        }
        const m = e.candidate.candidate.match(/(\d+\.\d+\.\d+\.\d+)/);
        if (m) set.add(m[1]);
      };
      pc.createOffer().then(o=>pc.setLocalDescription(o));
      setTimeout(()=>res("127.0.0.1"), 1500);
    });
  } catch (e) { return "127.0.0.1"; }
}

// ====================== å‘å¸ƒ/ç¼–è¾‘/æ¸²æŸ“ ======================
async function postMsg() {
  const qq = document.getElementById("qq").value.trim();
  const content = document.getElementById("content").value.trim();
  const now = Date.now()/1000|0;

  if (!qq || !content) return alert("è¯·å¡«å†™å®Œæ•´");
  if (content.length < config.minWords) return alert(`æœ€å°‘${config.minWords}å­—`);
  if (content.length > config.maxWords) return alert(`æœ€å¤š${config.maxWords}å­—`);
  if (now - lastPost < config.cooldown) return alert(`å†·å´ä¸­`);

  userIP = await getRealIP();
  if (blackList.some(b=>b.qq==qq||b.ip==userIP)) return alert("ä½ å·²è¢«æ‹‰é»‘");

  const words = config.badWords.split("\n").map(i=>i.trim()).filter(Boolean);
  for (const w of words) if (content.includes(w)) return alert("åŒ…å«æ•æ„Ÿè¯");

  msgList.unshift({
    qq, name:cutStr(currentNick||"çƒ­å¿ƒç½‘å‹"),
    avatar: `https://q.qlogo.cn/headimg_dl?dst_uin=${qq}&spec=100`,
    content, time: new Date().toLocaleString(),
    ip: userIP, isTop: false, tagsObj:[]
  });

  await syncData();
  lastPost = now;
  await sendQmsg(`æ˜µç§°ï¼š${currentNick||"çƒ­å¿ƒç½‘å‹"}\nQQï¼š${qq}\nå†…å®¹ï¼š${content}`);

  document.getElementById("qq").value = "";
  document.getElementById("content").value = "";
  currentNick = "";
  refreshTips();
  renderMsg();
  alert("âœ… å‘å¸ƒæˆåŠŸ");
}

function renderMsg() {
  const el = document.getElementById("msgWall");
  el.innerHTML = "";
  const show = msgList.filter(it=>!blackList.some(b=>b.qq==it.qq||b.ip==it.ip));
  show.sort((a,b)=>b.isTop - a.isTop);

  if (show.length === 0) {
    el.innerHTML = "<div style='text-align:center;padding:40px;color:#999'>æš‚æ— ç•™è¨€</div>";
    return;
  }

  show.forEach((it, idx)=>{
    const top = it.isTop ? '<span class="top-tag">ç½®é¡¶</span>' : '';
    const d = document.createElement("div");
    d.className = `message-item ${it.isTop?'top':''}`;
    d.innerHTML = `
      <div class="admin-actions" id="act_${idx}">
        <button class="act-del">åˆ </button>
        <button class="act-block">é»‘</button>
        <button class="act-top">é¡¶</button>
        <button class="act-edit">ç¼–</button>
      </div>
      <img src="${it.avatar}" class="avatar">
      <div class="msg-right">
        <div class="name">${it.name} ${top}</div>
        <div class="content">${it.content}</div>
        <div class="qq-time-ip">QQ: ${it.qq} | ${it.time} | IP: ${it.ip}</div>
      </div>
    `;
    el.appendChild(d);

    if (isLogin) {
      const a = document.getElementById(`act_${idx}`);
      a.style.display = "flex";
      a.querySelector(".act-del").onclick = ()=>{ msgList.splice(idx,1); syncData(); renderMsg(); };
      a.querySelector(".act-block").onclick = ()=>{ blackList.push({qq:it.qq,ip:it.ip}); syncBlack(); renderMsg(); };
      a.querySelector(".act-top").onclick = ()=>{ it.isTop = !it.isTop; syncData(); renderMsg(); };
      a.querySelector(".act-edit").onclick = ()=>{ editIndex=idx; document.getElementById('edit_name').value=it.name; document.getElementById('edit_qq').value=it.qq; document.getElementById('edit_content').value=it.content; document.getElementById('editModal').style.display='flex'; };
    }
  });
}

function closeEdit() { document.getElementById('editModal').style.display='none'; editIndex=-1; }
function saveEdit() {
  if (editIndex < 0) return;
  msgList[editIndex].name = document.getElementById('edit_name').value.trim();
  msgList[editIndex].qq   = document.getElementById('edit_qq').value.trim();
  msgList[editIndex].content = document.getElementById('edit_content').value.trim();
  syncData();
  closeEdit();
  renderMsg();
  alert("âœ… å·²ä¿å­˜");
}

// ====================== åå° ======================
function openBackend() {
  if (!isLogin) {
    const p = prompt("ç®¡ç†å¯†ç ï¼š");
    if (p !== adminPwd) return alert("å¯†ç é”™è¯¯");
    isLogin = true;
    document.getElementById("logoutBtn").style.display = "inline-block";
  }
  document.getElementById("backendModal").style.display = "flex";

  // æ‰“å¼€åå°æ—¶ï¼Œå¼ºåˆ¶ç”¨ç äº‘æœ€æ–°æ•°æ®å›å¡«ç•Œé¢ï¼ˆä¿®å¤ç‚¹4ï¼‰
  document.getElementById("set_min").value = config.minWords;
  document.getElementById("set_max").value = config.maxWords;
  document.getElementById("set_nick_max").value = config.nickMaxWords;
  document.getElementById("set_cd").value = config.cooldown;
  document.getElementById("set_push_title").value = config.pushTitle;
  document.getElementById("set_bad").value = config.badWords;

  document.getElementById("pushContent").value = pushConfig.content || "";
  document.getElementById("pushHour").value = pushConfig.hour || 0;
  document.getElementById("pushMin").value = pushConfig.min || 0;

  document.getElementById("gitee_token_input").value = getGiteeToken();
  renderBlack();
}

function renderBlack() {
  const el = document.getElementById("blackList");
  el.innerHTML = "";
  if (blackList.length === 0) {
    el.innerHTML = "<div style='text-align:center;color:#999'>æš‚æ— æ‹‰é»‘</div>";
    return;
  }
  blackList.forEach((it,i)=>{
    const d = document.createElement("div");
    d.className = "black-item";
    d.innerHTML = `<span>QQ:${it.qq} IP:${it.ip}</span><button class="unblock" onclick="unbind(${i})">è§£ç¦</button>`;
    el.appendChild(d);
  });
}
function unbind(i) { blackList.splice(i,1); syncBlack(); renderBlack(); }

function saveSetting() {
  config.minWords = +document.getElementById("set_min").value || 5;
  config.maxWords = +document.getElementById("set_max").value || 200;
  config.nickMaxWords = +document.getElementById("set_nick_max").value || 20;
  config.cooldown = +document.getElementById("set_cd").value || 30;
  config.pushTitle = document.getElementById("set_push_title").value.trim() || "ç•™è¨€å¢™é€šçŸ¥";
  syncConfig();
  refreshTips();
}
function saveBadWords() {
  config.badWords = document.getElementById("set_bad").value;
  syncConfig();
  alert("âœ… æ•æ„Ÿè¯å·²ä¿å­˜");
}
function saveNewPwd() {
  const np = document.getElementById("new_pwd").value.trim();
  if (!np) return alert("è¯·è¾“å…¥å¯†ç ");
  adminPwd = np;
  localStorage.setItem("adminPwd", np);
  alert("âœ… å¯†ç å·²ä¿®æ”¹");
}
function closeBackend() { document.getElementById("backendModal").style.display = "none"; }
function logoutAdmin() { isLogin = false; document.getElementById("logoutBtn").style.display = "none"; closeBackend(); }

// ====================== å¯åŠ¨ï¼ˆå¼ºåˆ¶åˆ·æ–°ï¼‰ ======================
(async ()=>{
  await loadFromGitee();  // ä¸€è¿›æ¥å°±æ‹‰ç äº‘æœ€æ–°
  userIP = await getRealIP();
  refreshTips();
  renderMsg();
})();
</script>
</body>
</html>
