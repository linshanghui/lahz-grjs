<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç•™è¨€å¢™</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}
body {
  background: #f7f7fa;
  padding: 12px;
  max-width: 600px;
  margin: 0 auto;
}
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  gap: 8px;
}
.title {
  font-size: 20px;
  font-weight: 600;
  color: #222;
}
.btn {
  padding: 8px 12px;
  border: none;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  white-space: nowrap;
}
.btn-primary {
  background: #409eff;
  color: #fff;
}
.btn-danger {
  background: #f56756;
  color: #fff;
}

.publish-card {
  background: #fff;
  border-radius: 16px;
  padding: 16px;
  margin-bottom: 16px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}
.publish-card input,
.publish-card textarea {
  width: 100%;
  padding: 12px 14px;
  border: 1px solid #eee;
  border-radius: 12px;
  margin-bottom: 10px;
  outline: none;
  font-size: 15px;
  background: #fafafa;
  transition: border 0.2s;
}
.publish-card input:focus,
.publish-card textarea:focus {
  border-color: #409eff;
}

.nick-preview {
  font-size: 13px;
  color: #409eff;
  margin: -5px 0 10px;
  display: none;
}
.word-tip {
  font-size: 13px;
  color: #666;
  margin: 0 0 10px;
}

.publish-card textarea {
  min-height: 100px;
  resize: none;
}
.publish-card button {
  width: 100%;
  padding: 12px;
  background: #409eff;
  color: #fff;
  border: none;
  border-radius: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: opacity 0.2s;
}
.publish-card button:hover {
  opacity: 0.9;
}

.message-wall {
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.message-item {
  background: #fff;
  border-radius: 16px;
  padding: 14px;
  position: relative;
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  display: flex;
  gap: 12px;
}
.message-item.top {
  border: 1px solid #ffd43b;
  background: #fffdf5;
}
.avatar {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  object-fit: cover;
  background: #eee;
  flex-shrink: 0;
}
.msg-right {
  flex: 1;
}
.name {
  font-weight: 600;
  font-size: 15px;
  color: #222;
  margin-bottom: 6px;
  display: flex;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
}
.top-tag {
  background: #FF7D00;
  color: #fff;
  font-size: 11px;
  padding: 2px 6px;
  border-radius: 4px;
  font-weight: bold;
}
.tag-item {
  font-size: 11px;
  padding: 2px 6px;
  border-radius: 4px;
  font-weight: bold;
  color: #fff;
}
.content {
  font-size: 15px;
  line-height: 1.5;
  color: #333;
  word-break: break-all;
}
.qq-time-ip {
  font-size: 12px;
  color: #999;
  display: flex;
  gap: 8px;
  align-items: center;
  flex-wrap: wrap;
  margin-top: 8px;
}

.admin-actions {
  position: absolute;
  top: 10px;
  right: 10px;
  display: none;
  gap: 4px;
}
.act-del { background: #f56756; width: 26px; height: 22px; font-size: 10px; border: none; border-radius: 4px; color: #fff; cursor: pointer; }
.act-block { background: #ff9f43; width: 26px; height: 22px; font-size: 10px; border: none; border-radius: 4px; color: #fff; cursor: pointer; }
.act-top { background: #409eff; width: 26px; height: 22px; font-size: 10px; border: none; border-radius: 4px; color: #fff; cursor: pointer; }
.act-edit { background: #722ed1; width: 26px; height: 22px; font-size: 10px; border: none; border-radius: 4px; color: #fff; cursor: pointer; }

.edit-modal {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 99999;
}
.edit-box {
  background: #fff;
  width: 90%;
  max-width: 400px;
  border-radius: 16px;
  padding: 20px;
}
.edit-box h4 {
  margin-bottom: 12px;
  font-size: 16px;
}
.edit-box input, .edit-box textarea {
  width: 100%;
  padding: 10px;
  margin-bottom: 10px;
  border: 1px solid #eee;
  border-radius: 8px;
  outline: none;
}
.edit-btns {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}
.edit-btns button {
  flex: 1;
  padding: 10px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}
.btn-save { background: #409eff; color: #fff; }
.btn-cancel { background: #f1f1f1; color: #333; }

.backend-modal {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.3);
  display: none;
  z-index: 9999;
}
.backend-box {
  background: #fff;
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
}
.backend-header {
  background: #409eff;
  color: #fff;
  padding: 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.backend-close {
  background: none; border: none;
  color: #fff; font-size: 20px;
  cursor: pointer;
}
.backend-body {
  flex: 1;
  padding: 16px;
  overflow-y: auto;
  background: #f7f7fa;
}
.section {
  background: #fff;
  border-radius: 14px;
  padding: 16px;
  margin-bottom: 14px;
}
.section h4 {
  margin-bottom: 12px;
  font-size: 16px;
}
.set-row {
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-bottom: 12px;
}
.set-row span {
  font-size: 14px;
  color: #555;
}
.set-row input {
  padding: 10px 12px;
  border: 1px solid #eee;
  border-radius: 10px;
  font-size: 15px;
  background: #fafafa;
}
textarea {
  width: 100%;
  height: 100px;
  padding: 12px;
  border: 1px solid #eee;
  border-radius: 10px;
  font-size: 14px;
  background: #fafafa;
  resize: none;
}
.save-btn {
  width: 100%;
  padding: 11px;
  background: #409eff;
  color: #fff;
  border: none;
  border-radius: 10px;
  margin-top: 6px;
  cursor: pointer;
}

.black-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 12px;
  background: #fafafa;
  border-radius: 10px;
  margin-bottom: 8px;
}
.unblock {
  background: #409eff;
  color: #fff;
  border: none;
  padding: 5px 9px;
  border-radius: 6px;
  font-size: 12px;
  cursor: pointer;
}
</style>
</head>
<body>

<div class="header">
  <div class="title">ğŸ’¬ ç•™è¨€å¢™</div>
  <div style="display:flex;gap:6px;">
    <button class="btn btn-primary" onclick="openBackend()">ç®¡ç†</button>
    <button class="btn btn-danger" id="logoutBtn" style="display:none;" onclick="logoutAdmin()">é€€å‡ºç™»å½•</button>
  </div>
</div>

<div class="publish-card">
  <input id="qq" placeholder="è¯·è¾“å…¥QQå·" autocomplete="off">
  <div class="nick-preview" id="nickPreview">æ­£åœ¨è·å–æ˜µç§°...</div>
  <div class="word-tip" id="nickWordTip"></div>

  <textarea id="content" placeholder="æƒ³è¯´ç‚¹ä»€ä¹ˆ..."></textarea>
  <div class="word-tip" id="contentWordTip"></div>

  <button onclick="postMsg()">å‘å¸ƒç•™è¨€</button>
</div>

<div class="message-wall" id="msgWall"></div>

<div class="edit-modal" id="editModal">
  <div class="edit-box">
    <h4>ç¼–è¾‘ç•™è¨€</h4>
    <input id="edit_name" placeholder="æ˜µç§°">
    <input id="edit_qq" placeholder="QQ">
    <input id="edit_time" placeholder="æ—¶é—´">
    <input id="edit_ip" placeholder="IP">
    <textarea id="edit_content" rows="4" placeholder="å†…å®¹"></textarea>
    <input id="edit_tags" placeholder="æ ¼å¼ï¼šæç¬‘:#ff5722 æ—¥å¸¸:#1890ff">
    <div class="edit-btns">
      <button class="btn-cancel" onclick="closeEdit()">å–æ¶ˆ</button>
      <button class="btn-save" onclick="saveEdit()">ä¿å­˜</button>
    </div>
  </div>
</div>

<div class="backend-modal" id="backendModal">
  <div class="backend-box">
    <div class="backend-header">
      <h3>ç®¡ç†åå°</h3>
      <button class="backend-close" onclick="closeBackend()">Ã—</button>
    </div>
    <div class="backend-body">
      <div class="section">
        <h4>åŸºç¡€è®¾ç½®</h4>
        <div class="set-row"><span>æœ€å°‘å­—æ•°</span><input id="set_min"></div>
        <div class="set-row"><span>æœ€å¤šå­—æ•°</span><input id="set_max"></div>
        <div class="set-row"><span>æ˜µç§°æœ€å¤§å­—æ•°</span><input id="set_nick_max"></div>
        <div class="set-row"><span>å‘è¨€é—´éš”(ç§’)</span><input id="set_cd"></div>
        <div class="set-row"><span>æ¨é€æ ‡é¢˜</span><input id="set_push_title" placeholder="ä¸ºç©ºåˆ™ä½¿ç”¨é»˜è®¤æ ‡é¢˜"></div>
        <button class="save-btn" onclick="saveSetting()">ä¿å­˜è®¾ç½®</button>
      </div>

      <div class="section" style="background:#e6f7ff;">
        <h4>ğŸ”§ æ¨é€åŠŸèƒ½</h4>
        <div class="set-row">
          <span>æ¨é€å†…å®¹</span>
          <textarea id="pushContent" placeholder="è¯·è¾“å…¥è¦æ¨é€çš„å†…å®¹"></textarea>
        </div>
        <div class="set-row">
          <button class="save-btn" style="background:#52c41a" onclick="manualPush()">ç«‹å³æ‰‹åŠ¨æ¨é€</button>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px;">
          <div style="flex:1;">
            <span>æ¯æ—¥å®šç‚¹å°æ—¶ï¼ˆ0-23ï¼‰</span>
            <input type="number" id="pushHour" min="0" max="23">
          </div>
          <div style="flex:1;">
            <span>æ¯æ—¥å®šç‚¹åˆ†é’Ÿï¼ˆ0-59ï¼‰</span>
            <input type="number" id="pushMin" min="0" max="59">
          </div>
        </div>
        <div style="display:flex;gap:6px;margin-top:8px;">
          <button class="save-btn" style="background:#ff9f43;flex:1" onclick="startDailyPush()">å¯åŠ¨æ¯æ—¥æ¨é€</button>
          <button class="save-btn" style="background:#f56756;flex:1" onclick="stopDailyPush()">åœæ­¢æ¯æ—¥æ¨é€</button>
        </div>
        <div style="margin-top:8px;">
          <button class="save-btn" style="background:#722ed1;" onclick="savePushConfigOnly()">ä¿å­˜æ¨é€é…ç½®</button>
        </div>
        <div style="font-size:12px;color:#666;margin-top:8px;">
          è®¿é—®æ¨é€é“¾æ¥ï¼š<span id="autoPushUrl"></span>
        </div>
      </div>

      <div class="section">
        <h4>æ•æ„Ÿè¯</h4>
        <textarea id="set_bad"></textarea>
        <button class="save-btn" onclick="saveBadWords()">ä¿å­˜æ•æ„Ÿè¯</button>
      </div>
      <div class="section">
        <h4>ä¿®æ”¹å¯†ç </h4>
        <div class="set-row"><span>æ–°å¯†ç </span><input id="new_pwd"></div>
        <button class="save-btn" onclick="saveNewPwd()">ä¿å­˜å¯†ç </button>
      </div>
      <div class="section">
        <h4>å·²æ‹‰é»‘</h4>
        <div id="blackList"></div>
      </div>
    </div>
  </div>
</div>

<script>
// ====================== ç¨³å®šç‰ˆ GITHUB å†™å…¥ ======================
const USER = "linshanghui";
const REPO = "lahz-grjs";
const TOKEN = "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";

const FILE_DATA  = "msg_data.json";
const FILE_CONF  = "msg_config.json";
const FILE_BLACK = "msg_black.json";

// æ¯æ¬¡éƒ½æ‹¿æœ€æ–° shaï¼Œç»å¯¹ç¨³å®š
async function githubSave(file, data) {
  try {
    // 1. æ‹¿æœ€æ–°ä¿¡æ¯
    const infoRes = await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/${file}`);
    const info = await infoRes.json();
    const sha = info.sha;

    // 2. ç¼–ç 
    const contentStr = JSON.stringify(data, null, 2);
    const base64 = btoa(unescape(encodeURIComponent(contentStr)));

    // 3. ä¸Šä¼ 
    await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/${file}`, {
      method: "PUT",
      headers: {
        "Authorization": `token ${TOKEN}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        message: "æ›´æ–°",
        content: base64,
        sha: sha
      })
    });
    return true;
  } catch (e) {
    console.error(e);
    return false;
  }
}

// è¯»å–
async function githubLoad(file) {
  try {
    const res = await fetch(`https://raw.githubusercontent.com/${USER}/${REPO}/main/${file}`);
    return await res.json();
  } catch (e) {
    return [];
  }
}

// å…¨å±€æ•°æ®
let adminPwd = "123456";
let config = {};
let msgList = [];
let blackList = [];

let pushConfig = { content: "", hour: 22, min: 23 };
let lastPost = 0;
let isLogin = false;
let userIP = "127.0.0.1";
let currentNickname = "";
let dailyTimer = null;
let editRealIndex = -1;

const QMSG_KEY = "bccdf562f8785c98f39b6cd53fe6ac32";
const tagColors = ["#13c2c2","#722ed1","#eb2f96","#1890ff","#52c41a","#faad14","#f5222d","#fa8c16"];

// ç»Ÿä¸€ä¿å­˜ä¸‰ä¸ªæ–‡ä»¶
async function saveMessages() { return githubSave(FILE_DATA, msgList); }
async function saveConfig()   { return githubSave(FILE_CONF, config); }
async function saveBlack()    { return githubSave(FILE_BLACK, blackList); }

// åŠ è½½å…¨éƒ¨
async function loadAll() {
  msgList = await githubLoad(FILE_DATA);
  config = await githubLoad(FILE_CONF);
  blackList = await githubLoad(FILE_BLACK);

  // åˆå§‹åŒ–é»˜è®¤é…ç½®
  if (!config || !config.minWords) {
    config = {
      minWords: 5,
      maxWords: 200,
      nickMaxWords: 20,
      cooldown: 30,
      badWords: "æ“\nå‚»é€¼\nå¦ˆçš„\nåƒåœ¾\næ»š",
      pushTitle: "ğŸ“¢ ç•™è¨€å¢™æœ‰äººç•™è¨€å•¦"
    };
    await saveConfig();
  }
  renderAll();
  refreshAllWordTip();
}

// ====================== ä»¥ä¸‹åŠŸèƒ½å®Œå…¨ä¸å˜ ======================
function getFixedColor(str) {
  let hash = 0;
  for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
  return tagColors[Math.abs(hash) % tagColors.length];
}
function parseTags(input) {
  if (!input) return [];
  return input.split(/\s+/).filter(i=>i.trim()).map(p=>{
    if(p.includes(':')){
      const [t,c]=p.split(':',2);return{text:t.trim(),color:c.trim()};
    }else return{text:p.trim(),color:getFixedColor(p)};
  });
}
function updateNickWordTip(){
  const v=document.getElementById('qq').value.trim();
  document.getElementById('nickWordTip').innerText=`æ˜µç§°å·²è¾“å…¥ ${v.length} / ${config.nickMaxWords}`;
}
function updateContentWordTip(){
  const v=document.getElementById('content').value;
  document.getElementById('contentWordTip').innerText=`å†…å®¹å·²è¾“å…¥ ${v.length} / ${config.maxWords}`;
}
function refreshAllWordTip(){updateNickWordTip();updateContentWordTip();}
function cutNick(n){return n.length>config.nickMaxWords?n.substring(0,config.nickMaxWords)+'...':n;}

async function getRealIP(){
  try {
    return new Promise(resolve => {
      const pc = new RTCPeerConnection({iceServers:[]});
      const ips = new Set();
      pc.createDataChannel("");
      pc.onicecandidate = e => {
        if (!e.candidate) {
          const arr = Array.from(ips);
          const local = arr.find(ip => ip.startsWith("192.168.") || ip.startsWith("10.") || ip.startsWith("172."));
          resolve(local || arr[0] || "127.0.0.1");
          return;
        }
        const m = e.candidate.candidate.match(/(\d+\.\d+\.\d+\.\d+)/);
        if (m) ips.add(m[1]);
      };
      pc.createOffer().then(o => pc.setLocalDescription(o));
      setTimeout(() => resolve("127.0.0.1"), 1500);
    });
  } catch (e) {
    return "127.0.0.1";
  }
}

async function sendQmsg(c){
  try{
    const t = config.pushTitle || "æ¨é€";
    const f = c.replace(/\d+/g, m => m.split('').join(' '));
    await fetch(`https://qmsg.zendee.cn/send/${QMSG_KEY}`,{
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body:`msg=${encodeURIComponent(t+'\n'+f)}`
    });
  }catch(e){}
}

async function manualPush(){
  const c=document.getElementById('pushContent').value.trim();
  if(!c)return alert('è¯·è¾“å…¥å†…å®¹');
  await sendQmsg(c);
  alert('æ¨é€æˆåŠŸ');
}
function savePushConfigOnly(){
  const c=document.getElementById('pushContent').value.trim();
  const h=+document.getElementById('pushHour').value||0;
  const m=+document.getElementById('pushMin').value||0;
  pushConfig={content:c,hour:h,min:m};
  alert('é…ç½®å·²ä¿å­˜');
}
function startDailyPush(){
  savePushConfigOnly();
  if(dailyTimer)clearTimeout(dailyTimer);
  if(!pushConfig.content)return alert('è¯·è¾“å…¥å†…å®¹');
  function calcNext(){
    const now=new Date();
    const target=new Date();
    target.setHours(pushConfig.hour,pushConfig.min,0,0);
    if(target<=now)target.setDate(target.getDate()+1);
    return target-now;
  }
  async function task(){
    await sendQmsg(pushConfig.content);
    scheduleNext();
  }
  function scheduleNext(){
    dailyTimer=setTimeout(task,calcNext());
  }
  scheduleNext();
  alert('å¯åŠ¨æˆåŠŸ');
}
function stopDailyPush(){
  if(dailyTimer)clearTimeout(dailyTimer);
  dailyTimer=null;
  alert('å·²åœæ­¢');
}
function genAutoPushUrl(){
  return location.origin+location.pathname+'?push=1';
}
async function checkUrlPush(){
  if(location.search.includes('push=1'))await sendQmsg(pushConfig.content||'æ¨é€');
}

async function getQQInfo(q){
  if(!/^\d{5,13}$/.test(q))return{nickname:'ç½‘å‹'};
  try{
    const r=await fetch(`https://uapis.cn/api/v1/social/qq/userinfo?qq=${q}`);
    const d=await r.json();
    if(d&&d.nickname)return{nickname:d.nickname};
  }catch(e){}
  return{nickname:'ç½‘å‹'};
}

let queryTimer=null;
document.getElementById('qq').addEventListener('input',function(){
  if(this.value.length>config.nickMaxWords)this.value=this.value.substring(0,config.nickMaxWords);
  updateNickWordTip();
  const q=this.value.trim();
  clearTimeout(queryTimer);
  currentNickname='';
  if(q.length<5){
    document.getElementById('nickPreview').style.display='none';
    return;
  }
  queryTimer=setTimeout(async()=>{
    document.getElementById('nickPreview').style.display='block';
    document.getElementById('nickPreview').textContent='è·å–ä¸­...';
    const i=await getQQInfo(q);
    currentNickname=i.nickname;
    document.getElementById('nickPreview').textContent=`æ˜µç§°ï¼š${cutNick(i.nickname)}`;
  },600);
});

document.getElementById('content').addEventListener('input',function(){
  if(this.value.length>config.maxWords)this.value=this.value.substring(0,config.maxWords);
  updateContentWordTip();
});

function openEdit(i){
  if(!isLogin)return;
  const m=msgList[i];
  if(!m)return;
  editRealIndex=i;
  document.getElementById('edit_name').value=m.name||'';
  document.getElementById('edit_qq').value=m.qq;
  document.getElementById('edit_time').value=m.time;
  document.getElementById('edit_ip').value=m.ip;
  document.getElementById('edit_content').value=m.content;
  document.getElementById('edit_tags').value=(m.tagsObj||[]).map(t=>`${t.text}:${t.color}`).join(' ');
  document.getElementById('editModal').style.display='flex';
}
function closeEdit(){
  document.getElementById('editModal').style.display='none';
  editRealIndex=-1;
}
async function saveEdit(){
  if(editRealIndex<0)return;
  const n=document.getElementById('edit_name').value.trim();
  const q=document.getElementById('edit_qq').value.trim();
  const t=document.getElementById('edit_time').value.trim();
  const ip=document.getElementById('edit_ip').value.trim();
  const c=document.getElementById('edit_content').value.trim();
  const ts=document.getElementById('edit_tags').value.trim();
  if(!q||!c)return alert('å¿…å¡«');
  const o=msgList[editRealIndex];
  o.name=n||'ç½‘å‹';
  o.qq=q;
  o.time=t;
  o.ip=ip;
  o.content=c;
  o.tagsObj=parseTags(ts);
  o.avatar=`https://q.qlogo.cn/headimg_dl?dst_uin=${q}&spec=100`;
  await saveMessages();
  closeEdit();
  renderMsg();
  alert('ä¿å­˜æˆåŠŸ');
}

function openBackend(){
  if(!isLogin){
    const p=prompt('å¯†ç ï¼š');
    if(p!==adminPwd)return alert('å¯†ç é”™è¯¯');
    isLogin=true;
    document.getElementById('logoutBtn').style.display='inline-block';
  }
  document.getElementById('backendModal').style.display='flex';
  document.getElementById('autoPushUrl').innerText=genAutoPushUrl();
  loadConfig();
  renderAll();
}
function closeBackend(){
  document.getElementById('backendModal').style.display='none';
}
function logoutAdmin(){
  isLogin=false;
  document.getElementById('logoutBtn').style.display='none';
  closeBackend();
  alert('å·²é€€å‡º');
}

function loadConfig(){
  document.getElementById('set_min').value=config.minWords;
  document.getElementById('set_max').value=config.maxWords;
  document.getElementById('set_nick_max').value=config.nickMaxWords;
  document.getElementById('set_cd').value=config.cooldown;
  document.getElementById('set_bad').value=config.badWords;
  document.getElementById('set_push_title').value=config.pushTitle||'';
}
async function saveSetting(){
  config.minWords=+document.getElementById('set_min').value||5;
  config.maxWords=+document.getElementById('set_max').value||200;
  config.nickMaxWords=+document.getElementById('set_nick_max').value||20;
  config.cooldown=+document.getElementById('set_cd').value||30;
  config.pushTitle=document.getElementById('set_push_title').value.trim()||'æ¨é€';
  await saveConfig();
  alert('ä¿å­˜æˆåŠŸ');
  refreshAllWordTip();
}
async function saveBadWords(){
  config.badWords=document.getElementById('set_bad').value;
  await saveConfig();
  alert('ä¿å­˜æˆåŠŸ');
}
function saveNewPwd(){
  const n=document.getElementById('new_pwd').value.trim();
  if(!n)return alert('è¯·è¾“å…¥');
  adminPwd=n;
  alert('ä¿®æ”¹æˆåŠŸ');
  document.getElementById('new_pwd').value='';
}

async function postMsg(){
  const q=document.getElementById('qq').value.trim();
  const c=document.getElementById('content').value.trim();
  const now=Math.floor(Date.now()/1000);

  if(!q)return alert('è¯·è¾“å…¥QQå·');
  if(!c)return alert('è¯·è¾“å…¥å†…å®¹');
  if(c.length<config.minWords)return alert(`æœ€å°‘${config.minWords}å­—`);
  if(c.length>config.maxWords)return alert(`æœ€å¤š${config.maxWords}å­—`);
  if(now-lastPost<config.cooldown)return alert(`å†·å´${config.cooldown}ç§’`);

  userIP=await getRealIP();

  if(blackList.some(b=>b.qq==q||b.ip==userIP))return alert('ä½ å·²è¢«æ‹‰é»‘');

  const badArr=config.badWords.split('\n').map(i=>i.trim()).filter(Boolean);
  for(const w of badArr){
    if(c.includes(w))return alert('å†…å®¹åŒ…å«æ•æ„Ÿè¯');
  }

  const msg={
    qq:q,
    name:cutNick(currentNickname||'ç½‘å‹'),
    avatar:`https://q.qlogo.cn/headimg_dl?dst_uin=${q}&spec=100`,
    content:c,
    time:new Date().toLocaleString(),
    ip:userIP,
    isTop:false,
    tagsObj:[]
  };

  msgList.unshift(msg);
  await saveMessages();
  lastPost=now;

  await sendQmsg(`æ˜µç§°ï¼š${msg.name}\nQQï¼š${q}\nIPï¼š${userIP}\nå†…å®¹ï¼š${c}`);

  document.getElementById('content').value='';
  document.getElementById('qq').value='';
  document.getElementById('nickPreview').style.display='none';
  currentNickname='';
  refreshAllWordTip();
  renderMsg();
  alert('å‘å¸ƒæˆåŠŸï¼');
}

function renderMsg(){
  const w=document.getElementById('msgWall');
  w.innerHTML='';
  const showList=msgList.filter(x=>!blackList.some(b=>b.qq==x.qq||b.ip==x.ip));
  const finalList=[...showList].sort((a,b)=>b.isTop-a.isTop);
  if(!finalList.length){
    w.innerHTML='<div style="text-align:center;padding:40px;color:#999">æš‚æ— ç•™è¨€</div>';
    return;
  }
  finalList.forEach((itm)=>{
    const realIdx=msgList.findIndex(x=>x.time==itm.time&&x.qq==itm.qq&&x.content==itm.content);
    const topHtml=itm.isTop?'<span class="top-tag">ç½®é¡¶</span>':'';
    const tagsHtml=(itm.tagsObj||[]).map(t=>
      `<span class="tag-item" style="background:${t.color}">${t.text}</span>`
    ).join('');

    const div=document.createElement('div');
    div.className='message-item'+(itm.isTop?' top':'');
    div.innerHTML=`
      <div class="admin-actions" id="act_${realIdx}">
        <button class="act-del">åˆ </button>
        <button class="act-block">é»‘</button>
        <button class="act-top">é¡¶</button>
        <button class="act-edit">ç¼–</button>
      </div>
      <img src="${itm.avatar}" class="avatar" onerror="this.src='https://q.qlogo.cn/headimg_dl?dst_uin=10000&spec=100'">
      <div class="msg-right">
        <div class="name">${itm.name} ${topHtml} ${tagsHtml}</div>
        <div class="content">${itm.content}</div>
        <div class="qq-time-ip">QQ: ${itm.qq} | ${itm.time} | IP: ${itm.ip}</div>
      </div>
    `;
    w.appendChild(div);

    if(isLogin){
      const act=document.getElementById(`act_${realIdx}`);
      act.style.display='flex';
      act.querySelector('.act-del').onclick=()=>doDel(realIdx);
      act.querySelector('.act-block').onclick=()=>doBlock(realIdx);
      act.querySelector('.act-top').onclick=()=>doTop(realIdx);
      act.querySelector('.act-edit').onclick=()=>openEdit(realIdx);
    }
  });
}

async function doDel(i){
  if(!isLogin)return;
  msgList.splice(i,1);
  await saveMessages();
  renderMsg();
}
async function doBlock(i){
  if(!isLogin)return;
  const m=msgList[i];
  if(!m)return;
  if(blackList.some(b=>b.qq==m.qq&&b.ip==m.ip))return alert('å·²æ‹‰é»‘');
  blackList.push({qq:m.qq,ip:m.ip});
  await saveBlack();
  alert('å·²æ‹‰é»‘');
  renderAll();
}
async function doTop(i){
  if(!isLogin)return;
  msgList[i].isTop=!msgList[i].isTop;
  await saveMessages();
  renderMsg();
}

function renderBlackList(){
  const el=document.getElementById('blackList');
  el.innerHTML='';
  if(!blackList.length){
    el.innerHTML='<div style="text-align:center;color:#999">æš‚æ— æ‹‰é»‘</div>';
    return;
  }
  blackList.forEach((itm,i)=>{
    const d=document.createElement('div');
    d.className='black-item';
    d.innerHTML=`
      <span>QQ:${itm.qq} IP:${itm.ip}</span>
      <button class="unblock" onclick="unblock(${i})">è§£ç¦</button>
    `;
    el.appendChild(d);
  });
}
async function unblock(i){
  blackList.splice(i,1);
  await saveBlack();
  renderAll();
}

function renderAll(){
  renderMsg();
  renderBlackList();
}

(async()=>{
  await loadAll();
  userIP=await getRealIP();
  await checkUrlPush();
})();
</script>
</body>
</html>
