<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç•™è¨€å¢™</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif}
body{background:#f7f7fa;padding:12px;max-width:600px;margin:0 auto}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;gap:8px}
.title{font-size:20px;font-weight:600;color:#222}
.btn{padding:8px 12px;border:none;border-radius:10px;font-size:14px;font-weight:500;cursor:pointer}
.btn-primary{background:#409eff;color:#fff}
.btn-danger{background:#f56756;color:#fff}

.publish-card{background:#fff;border-radius:16px;padding:16px;margin-bottom:16px;box-shadow:0 2px 10px rgba(0,0,0,.05)}
.publish-card input,.publish-card textarea{width:100%;padding:12px 14px;border:1px solid #eee;border-radius:12px;margin-bottom:10px;outline:none;font-size:15px}
.publish-card input:focus,.publish-card textarea:focus{border-color:#409eff}
.nick-preview{font-size:13px;color:#409eff;margin:-5px 0 10px;display:none}
.word-tip{font-size:13px;color:#666;margin-bottom:10px}
.publish-card textarea{min-height:100px;resize:none}
.publish-card button{width:100%;padding:12px;background:#409eff;color:#fff;border:none;border-radius:12px}

.message-wall{display:flex;flex-direction:column;gap:12px}
.message-item{background:#fff;border-radius:16px;padding:14px;position:relative;box-shadow:0 2px 8px rgba(0,0,0,.04);display:flex;gap:12px}
.message-item.top{border:1px solid #ffd433;background:#fffdf5}
.avatar{width:42px;height:42px;border-radius:50%;object-fit:cover;background:#eee;flex-shrink:0}
.msg-right{flex:1}
.name{font-weight:600;font-size:15px;color:#222;margin-bottom:6px;display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.top-tag{background:#fa8c16;color:#fff;font-size:11px;padding:2px 6px;border-radius:4px}
.content{font-size:15px;line-height:1.5;color:#333;word-break:break-all}
.qq-time-ip{font-size:12px;color:#999;display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}

.admin-actions{position:absolute;top:10px;right:10px;display:none;gap:4px}
.act-del{background:#f56756;width:26px;height:22px;font-size:10px;border:none;border-radius:4px;color:#fff}
.act-block{background:#fa8c16;width:26px;height:22px;font-size:10px;border:none;border-radius:4px;color:#fff}
.act-top{background:#409eff;width:26px;height:22px;font-size:10px;border:none;border-radius:4px;color:#fff}
.act-edit{background:#722ed1;width:26px;height:22px;font-size:10px;border:none;border-radius:4px;color:#fff}

.edit-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;justify-content:center;align-items:center;z-index:99999}
.edit-box{background:#fff;width:90%;max-width:400px;border-radius:16px;padding:20px}
.edit-btns{display:flex;gap:10px;margin-top:10px}
.edit-btns button{flex:1;padding:10px;border:none;border-radius:8px}
.btn-save{background:#409eff;color:#fff}
.btn-cancel{background:#f1f1f1}

.backend-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.3);display:none;z-index:9999}
.backend-box{background:#fff;width:100%;height:100%;display:flex;flex-direction:column}
.backend-header{background:#409eff;color:#fff;padding:16px;display:flex;justify-content:space-between;align-items:center}
.backend-close{background:none;border:none;color:#fff;font-size:20px;cursor:pointer}
.backend-body{flex:1;padding:16px;overflow-y:auto}
.section{background:#fff;border-radius:14px;padding:16px;margin-bottom:14px}
.set-row{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
.save-btn{width:100%;padding:11px;background:#409eff;color:#fff;border:none;border-radius:10px;margin-top:6px}
.black-item{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#fafafa;border-radius:10px;margin-bottom:8px}
.unblock{background:#409eff;color:#fff;border:none;padding:5px 9px;border-radius:6px}
</style>
</head>

<body>
<div class="header">
  <div class="title">ğŸ’¬ ç•™è¨€å¢™</div>
  <div>
    <button class="btn btn-primary" onclick="openBackend()">ç®¡ç†</button>
    <button class="btn btn-danger" id="logoutBtn" style="display:none;margin-left:8px">é€€å‡º</button>
  </div>
</div>

<div class="publish-card">
  <input id="qq" placeholder="QQå·" autocomplete="off">
  <div class="nick-preview" id="nickPreview"></div>
  <div class="word-tip" id="nickWordTip"></div>
  <textarea id="content" placeholder="æƒ³è¯´ç‚¹ä»€ä¹ˆ..."></textarea>
  <div class="word-tip" id="contentWordTip"></div>
  <button onclick="postMsg()">å‘å¸ƒç•™è¨€</button>
</div>

<div class="message-wall" id="msgWall">åŠ è½½ä¸­...</div>

<div class="edit-modal" id="editModal">
  <div class="edit-box">
    <h4>ç¼–è¾‘ç•™è¨€</h4>
    <input id="edit_name" placeholder="æ˜µç§°">
    <input id="edit_qq" placeholder="QQ">
    <input id="edit_time" placeholder="æ—¶é—´">
    <input id="edit_ip" placeholder="IP">
    <textarea id="edit_content" rows="4" placeholder="å†…å®¹"></textarea>
    <div class="edit-btns">
      <button class="btn-cancel" onclick="closeEdit()">å–æ¶ˆ</button>
      <button class="btn-save" onclick="saveEdit()">ä¿å­˜</button>
    </div>
  </div>
</div>

<div class="backend-modal" id="backendModal">
  <div class="backend-box">
    <div class="backend-header"><h3>ç®¡ç†åå°</h3><button class="backend-close" onclick="closeBackend()">Ã—</button></div>
    <div class="backend-body">
      <div class="section" style="background:#fff7e6">
        <h4>ğŸ” ç äº‘ä»¤ç‰Œ</h4>
        <div class="set-row"><input type="password" id="gitee_token_input" placeholder="ä»¤ç‰Œ"></div>
        <button class="save-btn" style="background:#fa8c16" onclick="saveGiteeTokenLocal()">ä¿å­˜ä»¤ç‰Œ</button>
      </div>

      <div class="section">
        <h4>åŸºç¡€è®¾ç½®</h4>
        <div class="set-row"><span>æœ€å°å­—æ•°</span><input id="set_min"></div>
        <div class="set-row"><span>æœ€å¤§å­—æ•°</span><input id="set_max"></div>
        <div class="set-row"><span>å‘è¨€å†·å´</span><input id="set_cd"></div>
        <div class="set-row"><span>æ¨é€æ ‡é¢˜</span><input id="set_push_title"></div>
        <button class="save-btn" onclick="saveSetting()">ä¿å­˜è®¾ç½®</button>
      </div>

      <div class="section" style="background:#e6f7ff">
        <h4>æ¨é€è®¾ç½®</h4>
        <div class="set-row"><textarea id="pushContent" placeholder="æ¨é€å†…å®¹"></textarea></div>
        <button class="save-btn" style="background:#52c41a" onclick="manualPush()">ç«‹å³æ¨é€</button>
        <div style="display:flex;gap:8px;margin-top:8px">
          <div style="flex:1"><input type="number" id="pushHour" placeholder="å°æ—¶"></div>
          <div style="flex:1"><input type="number" id="pushMin" placeholder="åˆ†é’Ÿ"></div>
        </div>
        <button class="save-btn" style="background:#ff9f43;margin-top:8px" onclick="startDailyPush()">å¯åŠ¨å®šæ—¶</button>
        <button class="save-btn" style="background:#f56756;margin-top:8px" onclick="stopDailyPush()">åœæ­¢å®šæ—¶</button>
      </div>

      <div class="section">
        <h4>æ•æ„Ÿè¯</h4><textarea id="set_bad"></textarea>
        <button class="save-btn" onclick="saveBadWords()">ä¿å­˜</button>
      </div>

      <div class="section">
        <h4>ä¿®æ”¹å¯†ç </h4><input id="new_pwd">
        <button class="save-btn" onclick="saveNewPwd()">ä¿å­˜</button>
      </div>

      <div class="section"><h4>é»‘åå•</h4><div id="blackList"></div></div>
    </div>
  </div>
</div>

<script>
// ====================== é…ç½® ======================
const OWNER = "linshanghui";
const REPO  = "lahz-grjs";
const BRANCH = "main";
const API = "https://gitee.com/api/v5";
const RAW = `https://gitee.com/${OWNER}/${REPO}/raw/${BRANCH}`;

const FILE_CONFIG = "msg_config.json";
const FILE_DATA   = "msg_data.json";
const FILE_BLACK  = "msg_black.json";

const defaultConfig = {
  minWords:5, maxWords:200, cooldown:30,
  badWords:"", pushTitle:"ç•™è¨€å¢™é€šçŸ¥",
  pushConfig:{content:"", hour:22, min:0}
};

let config    = {...defaultConfig};
let msgList   = [];
let blackList = [];
let pushConfig = {...defaultConfig.pushConfig};

let adminPwd  = localStorage.getItem('adminPwd') || "123456";
let token     = () => localStorage.getItem("gitee_token") || "";
let lastPost  = 0;
let isLogin   = false;
let dailyTimer = null;
let editIndex = -1;

// ====================== å¼ºåˆ¶ä»ç äº‘æ‹‰å–ï¼Œæ°¸ä¸ç¼“å­˜ï¼======================
async function fetchJson(url) {
  try {
    const res = await fetch(url + "?t=" + Date.now()); // å…³é”®ï¼šæ—¶é—´æˆ³é˜²ç¼“å­˜
    if (!res.ok) return null;
    return await res.json();
  } catch (e) {
    return null;
  }
}

// é¡µé¢ä¸€æ‰“å¼€å°±åŠ è½½æœ€æ–°æ•°æ®
async function loadAll() {
  document.getElementById("msgWall").innerText = "æ­£åœ¨åŠ è½½ç•™è¨€...";

  const conf = await fetchJson(`${RAW}/${FILE_CONFIG}`);
  const data = await fetchJson(`${RAW}/${FILE_DATA}`);
  const black = await fetchJson(`${RAW}/${FILE_BLACK}`);

  if (conf)  config    = conf;
  if (data)  msgList   = data;
  if (black) blackList = black;
  if (config.pushConfig) pushConfig = config.pushConfig;

  renderMsg(); // åŠ è½½å®Œå†æ¸²æŸ“ â†’ æ°¸è¿œä¸ä¼šç©ºç™½ã€ä¸ä¼šä¸¢ç•™è¨€
  refreshTips();
}

// ====================== ä¸Šä¼  ======================
function b64(s) { return btoa(unescape(encodeURIComponent(s))); }

async function upload(path, content, msg) {
  const t = token();
  if (!t) return alert("è¯·é…ç½®ä»¤ç‰Œ");
  try {
    let sha = "";
    const get = await fetch(`${API}/repos/${OWNER}/${REPO}/contents/${path}?access_token=${t}&ref=${BRANCH}`);
    if (get.ok) sha = (await get.json()).sha;

    const body = { access_token:t, content:b64(content), message:msg, branch:BRANCH };
    if (sha) body.sha = sha;

    await fetch(`${API}/repos/${OWNER}/${REPO}/contents/${path}`, {
      method:"PUT", headers:{"Content-Type":"application/json"}, body:JSON.stringify(body)
    });
    alert("âœ… å·²åŒæ­¥");
  } catch (e) { alert("âŒ ä¸Šä¼ å¤±è´¥"); }
}

function syncConfig() { config.pushConfig = pushConfig; upload(FILE_CONFIG, JSON.stringify(config, null, 2), "update config"); }
function syncData()   { upload(FILE_DATA,   JSON.stringify(msgList, null, 2), "update msg"); }
function syncBlack()  { upload(FILE_BLACK, JSON.stringify(blackList, null, 2), "update black"); }

// ====================== æ¨é€ ======================
async function send(text) {
  await fetch(`https://qmsg.zendee.cn/send/bccdf562f8785c98f39b6cd53fe6ac32`, {
    method:"POST", headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body:`msg=${encodeURIComponent(config.pushTitle+"\n"+text)}`
  });
}

async function manualPush() {
  const t = document.getElementById("pushContent").value.trim();
  if (!t) return alert("è¯·è¾“å…¥å†…å®¹");
  await send(t);
  alert("âœ… æ¨é€æˆåŠŸ");
}

function startDailyPush() {
  pushConfig.content = document.getElementById("pushContent").value.trim();
  pushConfig.hour = +document.getElementById("pushHour").value || 0;
  pushConfig.min = +document.getElementById("pushMin").value || 0;
  syncConfig();

  if (dailyTimer) clearTimeout(dailyTimer);
  const run = async () => { await send(pushConfig.content); dailyTimer = setTimeout(run, 86400000); };
  const now = new Date();
  const tar = new Date();
  tar.setHours(pushConfig.hour, pushConfig.min, 0, 0);
  if (tar <= now) tar.setDate(tar.getDate()+1);
  setTimeout(run, tar-now);
  alert("âœ… å®šæ—¶å·²å¯åŠ¨");
}

// ====================== ç•™è¨€æ¸²æŸ“ï¼ˆæ°¸è¿œæ­£å¸¸æ˜¾ç¤ºï¼‰======================
function renderMsg() {
  const el = document.getElementById("msgWall");
  el.innerHTML = "";

  // è¿‡æ»¤é»‘åå• + æ’åº
  const list = msgList.filter(m => !blackList.some(b => b.qq == m.qq || b.ip == m.ip));
  list.sort((a,b) => b.isTop - a.isTop);

  if (list.length === 0) {
    el.innerHTML = "<div style='text-align:center;padding:40px;color:#999'>æš‚æ— ç•™è¨€</div>";
    return;
  }

  list.forEach((m, idx) => {
    const item = document.createElement("div");
    item.className = "message-item" + (m.isTop ? " top" : "");
    item.innerHTML = `
      <div class="admin-actions" id="act_${idx}">
        <button class="act-del">åˆ </button>
        <button class="act-block">é»‘</button>
        <button class="act-top">é¡¶</button>
        <button class="act-edit">ç¼–</button>
      </div>
      <img src="${m.avatar}" class="avatar">
      <div class="msg-right">
        <div class="name">${m.name} ${m.isTop?'<span class="top-tag">é¡¶</span>':''}</div>
        <div class="content">${m.content}</div>
        <div class="qq-time-ip">${m.qq} | ${m.time} | ${m.ip}</div>
      </div>
    `;
    el.appendChild(item);

    if (isLogin) {
      const a = document.getElementById(`act_${idx}`);
      a.style.display = "flex";
      a.querySelector(".act-del").onclick = () => { msgList.splice(idx,1); syncData(); renderMsg(); };
      a.querySelector(".act-block").onclick = () => { blackList.push({qq:m.qq,ip:m.ip}); syncBlack(); renderMsg(); };
      a.querySelector(".act-top").onclick = () => { m.isTop = !m.isTop; syncData(); renderMsg(); };
      a.querySelector(".act-edit").onclick = () => { editIndex=idx; document.getElementById('edit_name').value=m.name; document.getElementById('edit_qq').value=m.qq; document.getElementById('edit_content').value=m.content; document.getElementById('editModal').style.display="flex"; };
    }
  });
}

// ====================== å‘å¸ƒç•™è¨€ ======================
async function postMsg() {
  const qq = document.getElementById("qq").value.trim();
  const content = document.getElementById("content").value.trim();
  const now = Date.now()/1000|0;

  if (!qq || !content) return alert("è¯·å¡«å†™å®Œæ•´");
  if (now-lastPost < config.cooldown) return alert("å†·å´ä¸­");

  msgList.unshift({
    qq, name:"ç½‘å‹", avatar:`https://q.qlogo.cn/headimg_dl?dst_uin=${qq}&spec=100`,
    content, time:new Date().toLocaleString(), ip:"", isTop:false
  });

  await syncData();
  await send(`æ–°ç•™è¨€ï¼š${content}`);
  lastPost = now;
  document.getElementById("qq").value = "";
  document.getElementById("content").value = "";
  renderMsg();
  alert("âœ… å‘å¸ƒæˆåŠŸ");
}

// ====================== å·¥å…· ======================
function refreshTips() {
  const ql = document.getElementById("qq").value.length;
  const cl = document.getElementById("content").value.length;
  document.getElementById("nickWordTip").innerText = `QQ: ${ql}/20`;
  document.getElementById("contentWordTip").innerText = `å†…å®¹: ${cl}/${config.maxWords}`;
}

function saveGiteeTokenLocal() { localStorage.setItem("gitee_token", document.getElementById("gitee_token_input").value.trim()); alert("âœ… å·²ä¿å­˜"); }
function closeEdit() { document.getElementById("editModal").style.display="none"; }
function saveEdit() { if (editIndex<0) return; msgList[editIndex].name=document.getElementById("edit_name").value; msgList[editIndex].content=document.getElementById("edit_content").value; syncData(); closeEdit(); renderMsg(); }
function openBackend() { if(!isLogin){const p=prompt("å¯†ç ï¼š");if(p!==adminPwd)return;isLogin=1;document.getElementById("logoutBtn").style.display="inline-block"} document.getElementById("backendModal").style.display="flex"; }
function closeBackend() { document.getElementById("backendModal").style.display="none"; }
function logoutAdmin() { isLogin=0; document.getElementById("logoutBtn").style.display="none"; closeBackend(); }
function saveSetting() { config.minWords=+document.getElementById("set_min").value||5; config.maxWords=+document.getElementById("set_max").value||200; config.cooldown=+document.getElementById("set_cd").value||30; config.pushTitle=document.getElementById("set_push_title").value||"ç•™è¨€é€šçŸ¥"; syncConfig(); }
function saveBadWords() { config.badWords=document.getElementById("set_bad").value; syncConfig(); }
function saveNewPwd() { adminPwd=document.getElementById("new_pwd").value; localStorage.setItem("adminPwd",adminPwd); alert("âœ… å·²ä¿®æ”¹"); }
function stopDailyPush() { if(dailyTimer) clearTimeout(dailyTimer); alert("âœ… å·²åœæ­¢"); }

// å¯åŠ¨ï¼
loadAll();
</script>
</body>
</html>
