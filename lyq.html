<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç•™è¨€å¢™</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}
body {
  background: #f7f7fa;
  padding: 12px;
  max-width: 600px;
  margin: 0 auto;
}
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  gap: 8px;
}
.title {
  font-size: 20px;
  font-weight: 600;
  color: #222;
}
.btn {
  padding: 8px 12px;
  border: none;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  white-space: nowrap;
}
.btn-primary {
  background: #409eff;
  color: #fff;
}
.btn-danger {
  background: #f56756;
  color: #fff;
}

.publish-card {
  background: #fff;
  border-radius: 16px;
  padding: 16px;
  margin-bottom: 16px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}
.publish-card input,
.publish-card textarea {
  width: 100%;
  padding: 12px 14px;
  border: 1px solid #eee;
  border-radius: 12px;
  margin-bottom: 10px;
  outline: none;
  font-size: 15px;
  background: #fafafa;
  transition: border 0.2s;
}
.publish-card input:focus,
.publish-card textarea:focus {
  border-color: #409eff;
}

.nick-preview {
  font-size: 13px;
  color: #409eff;
  margin: -5px 0 10px;
  display: none;
}
.word-tip {
  font-size: 13px;
  color: #666;
  margin: 0 0 10px;
}

.publish-card textarea {
  min-height: 100px;
  resize: none;
}
.publish-card button {
  width: 100%;
  padding: 12px;
  background: #409eff;
  color: #fff;
  border: none;
  border-radius: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: opacity 0.2s;
}
.publish-card button:hover {
  opacity: 0.9;
}

.message-wall {
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.message-item {
  background: #fff;
  border-radius: 16px;
  padding: 14px;
  position: relative;
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  display: flex;
  gap: 12px;
}
.message-item.top {
  border: 1px solid #ffd43b;
  background: #fffdf5;
}
.avatar {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  object-fit: cover;
  background: #eee;
  flex-shrink: 0;
}
.msg-right {
  flex: 1;
}
.name {
  font-weight: 600;
  font-size: 15px;
  color: #222;
  margin-bottom: 6px;
  display: flex;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
}
.top-tag {
  background: #FF7D00;
  color: #fff;
  font-size: 11px;
  padding: 2px 6px;
  border-radius: 4px;
  font-weight: bold;
}
.tag-item {
  font-size: 11px;
  padding: 2px 6px;
  border-radius: 4px;
  font-weight: bold;
  color: #fff;
}
.content {
  font-size: 15px;
  line-height: 1.5;
  color: #333;
  word-break: break-all;
}
.qq-time-ip {
  font-size: 12px;
  color: #999;
  display: flex;
  gap: 8px;
  align-items: center;
  flex-wrap: wrap;
  margin-top: 8px;
}

.admin-actions {
  position: absolute;
  top: 10px;
  right: 10px;
  display: none;
  gap: 4px;
}
.act-del { background: #f56756; width: 26px; height: 22px; font-size: 10px; border: none; border-radius: 4px; color: #fff; cursor: pointer; }
.act-block { background: #ff9f43; width: 26px; height: 22px; font-size: 10px; border: none; border-radius: 4px; color: #fff; cursor: pointer; }
.act-top { background: #409eff; width: 26px; height: 22px; font-size: 10px; border: none; border-radius: 4px; color: #fff; cursor: pointer; }
.act-edit { background: #722ed1; width: 26px; height: 22px; font-size: 10px; border: none; border-radius: 4px; color: #fff; cursor: pointer; }

.edit-modal {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 99999;
}
.edit-box {
  background: #fff;
  width: 90%;
  max-width: 400px;
  border-radius: 16px;
  padding: 20px;
}
.edit-box h4 {
  margin-bottom: 12px;
  font-size: 16px;
}
.edit-box input, .edit-box textarea {
  width: 100%;
  padding: 10px;
  margin-bottom: 10px;
  border: 1px solid #eee;
  border-radius: 8px;
  outline: none;
}
.edit-btns {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}
.edit-btns button {
  flex: 1;
  padding: 10px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}
.btn-save { background: #409eff; color: #fff; }
.btn-cancel { background: #f1f1f1; color: #333; }

.backend-modal {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.3);
  display: none;
  z-index: 9999;
}
.backend-box {
  background: #fff;
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
}
.backend-header {
  background: #409eff;
  color: #fff;
  padding: 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.backend-close {
  background: none; border: none;
  color: #fff; font-size: 20px;
  cursor: pointer;
}
.backend-body {
  flex: 1;
  padding: 16px;
  overflow-y: auto;
  background: #f7f7fa;
}
.section {
  background: #fff;
  border-radius: 14px;
  padding: 16px;
  margin-bottom: 14px;
}
.section h4 {
  margin-bottom: 12px;
  font-size: 16px;
}
.set-row {
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-bottom: 12px;
}
.set-row span {
  font-size: 14px;
  color: #555;
}
.set-row input {
  padding: 10px 12px;
  border: 1px solid #eee;
  border-radius: 10px;
  font-size: 15px;
  background: #fafafa;
}
textarea {
  width: 100%;
  height: 100px;
  padding: 12px;
  border: 1px solid #eee;
  border-radius: 10px;
  font-size: 14px;
  background: #fafafa;
  resize: none;
}
.save-btn {
  width: 100%;
  padding: 11px;
  background: #409eff;
  color: #fff;
  border: none;
  border-radius: 10px;
  margin-top: 6px;
  cursor: pointer;
}

.black-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 12px;
  background: #fafafa;
  border-radius: 10px;
  margin-bottom: 8px;
}
.unblock {
  background: #409eff;
  color: #fff;
  border: none;
  padding: 5px 9px;
  border-radius: 6px;
  font-size: 12px;
  cursor: pointer;
}
</style>
</head>
<body>

<div class="header">
  <div class="title">ğŸ’¬ ç•™è¨€å¢™</div>
  <div style="display:flex;gap:6px;">
    <button class="btn btn-primary" onclick="openBackend()">ç®¡ç†</button>
    <button class="btn btn-danger" id="logoutBtn" style="display:none;" onclick="logoutAdmin()">é€€å‡ºç™»å½•</button>
  </div>
</div>

<div class="publish-card">
  <input id="qq" placeholder="è¯·è¾“å…¥QQå·" autocomplete="off">
  <div class="nick-preview" id="nickPreview">æ­£åœ¨è·å–æ˜µç§°...</div>
  <div class="word-tip" id="nickWordTip"></div>

  <textarea id="content" placeholder="æƒ³è¯´ç‚¹ä»€ä¹ˆ..."></textarea>
  <div class="word-tip" id="contentWordTip"></div>

  <button onclick="postMsg()">å‘å¸ƒç•™è¨€</button>
</div>

<div class="message-wall" id="msgWall"></div>

<div class="edit-modal" id="editModal">
  <div class="edit-box">
    <h4>ç¼–è¾‘ç•™è¨€</h4>
    <input id="edit_name" placeholder="æ˜µç§°">
    <input id="edit_qq" placeholder="QQ">
    <input id="edit_time" placeholder="æ—¶é—´">
    <input id="edit_ip" placeholder="IP">
    <textarea id="edit_content" rows="4" placeholder="å†…å®¹"></textarea>
    <input id="edit_tags" placeholder="æ ¼å¼ï¼šæç¬‘:#ff5722 æ—¥å¸¸:#1890ff">
    <div class="edit-btns">
      <button class="btn-cancel" onclick="closeEdit()">å–æ¶ˆ</button>
      <button class="btn-save" onclick="saveEdit()">ä¿å­˜</button>
    </div>
  </div>
</div>

<div class="backend-modal" id="backendModal">
  <div class="backend-box">
    <div class="backend-header">
      <h3>ç®¡ç†åå°</h3>
      <button class="backend-close" onclick="closeBackend()">Ã—</button>
    </div>
    <div class="backend-body">
      <div class="section">
        <h4>åŸºç¡€è®¾ç½®</h4>
        <div class="set-row"><span>æœ€å°‘å­—æ•°</span><input id="set_min"></div>
        <div class="set-row"><span>æœ€å¤šå­—æ•°</span><input id="set_max"></div>
        <div class="set-row"><span>æ˜µç§°æœ€å¤§å­—æ•°</span><input id="set_nick_max"></div>
        <div class="set-row"><span>å‘è¨€é—´éš”(ç§’)</span><input id="set_cd"></div>
        <div class="set-row"><span>æ¨é€æ ‡é¢˜</span><input id="set_push_title" placeholder="ä¸ºç©ºåˆ™ä½¿ç”¨é»˜è®¤æ ‡é¢˜"></div>
        <button class="save-btn" onclick="saveSetting()">ä¿å­˜è®¾ç½®</button>
      </div>

      <div class="section" style="background:#e6f7ff;">
        <h4>ğŸ”§ æ¨é€åŠŸèƒ½</h4>
        <div class="set-row">
          <span>æ¨é€å†…å®¹</span>
          <textarea id="pushContent" placeholder="è¯·è¾“å…¥è¦æ¨é€çš„å†…å®¹"></textarea>
        </div>
        <div class="set-row">
          <button class="save-btn" style="background:#52c41a" onclick="manualPush()">ç«‹å³æ‰‹åŠ¨æ¨é€</button>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px;">
          <div style="flex:1;">
            <span>æ¯æ—¥å®šç‚¹å°æ—¶ï¼ˆ0-23ï¼‰</span>
            <input type="number" id="pushHour" min="0" max="23">
          </div>
          <div style="flex:1;">
            <span>æ¯æ—¥å®šç‚¹åˆ†é’Ÿï¼ˆ0-59ï¼‰</span>
            <input type="number" id="pushMin" min="0" max="59">
          </div>
        </div>
        <div style="display:flex;gap:6px;margin-top:8px;">
          <button class="save-btn" style="background:#ff9f43;flex:1" onclick="startDailyPush()">å¯åŠ¨æ¯æ—¥æ¨é€</button>
          <button class="save-btn" style="background:#f56756;flex:1" onclick="stopDailyPush()">åœæ­¢æ¯æ—¥æ¨é€</button>
        </div>
        <div style="margin-top:8px;">
          <button class="save-btn" style="background:#722ed1;" onclick="savePushConfigOnly()">ä¿å­˜æ¨é€é…ç½®</button>
        </div>
        <div style="font-size:12px;color:#666;margin-top:8px;">
          è®¿é—®æ¨é€é“¾æ¥ï¼š<span id="autoPushUrl"></span>
        </div>
      </div>

      <div class="section">
        <h4>æ•æ„Ÿè¯</h4>
        <textarea id="set_bad"></textarea>
        <button class="save-btn" onclick="saveBadWords()">ä¿å­˜æ•æ„Ÿè¯</button>
      </div>
      <div class="section">
        <h4>ä¿®æ”¹å¯†ç </h4>
        <div class="set-row"><span>æ–°å¯†ç </span><input id="new_pwd"></div>
        <button class="save-btn" onclick="saveNewPwd()">ä¿å­˜å¯†ç </button>
      </div>
      <div class="section">
        <h4>å·²æ‹‰é»‘</h4>
        <div id="blackList"></div>
      </div>
    </div>
  </div>
</div>

<script>
// ====================== æœ€ç»ˆå¯è§¦å‘ç‰ˆ Â· æ— å¯†é’¥ ======================
const GH_OWNER   = "linshanghui";
const GH_REPO    = "lahz-grjs";
const GH_BRANCH  = "main";
const GH_RAW     = `https://raw.githubusercontent.com/${GH_OWNER}/${GH_REPO}/${GH_BRANCH}`;

const FILE_CONFIG = "msg_config.json";
const FILE_DATA   = "msg_data.json";
const FILE_BLACK  = "msg_black.json";

let adminPwd = localStorage.getItem('adminPwd') || "123456";
const defaultConfig = {
  minWords:5, maxWords:200, nickMaxWords:20, cooldown:30,
  badWords:"æ“\nå‚»é€¼\nå¦ˆçš„\nåƒåœ¾\næ»š",
  pushTitle:"ğŸ“¢ ç•™è¨€å¢™æœ‰äººç•™è¨€å•¦"
};

let config    = {...defaultConfig};
let msgList   = [];
let blackList = [];
let pushConfig = JSON.parse(localStorage.getItem('pushConfig')) || {content:"", hour:22, min:23};

let lastPost = 0, isLogin = false, userIP = "127.0.0.1";
let currentNickname = "", dailyTimer = null, editRealIndex = -1;
const QMSG_KEY = "bccdf562f785c98f39b6cd53fe6ac32";
const tagColors = ["#13c2c2","#722ed1","#eb2f96","#1890ff","#52c41a","#faad14","#f5222d","#fa8c16"];

// è¯»å–
async function ghGet(file) {
  try {
    const r = await fetch(`${GH_RAW}/${file}`);
    if (r.ok) return await r.json();
  } catch(e) {}
  return file === FILE_CONFIG ? {...defaultConfig} : [];
}

// âœ… ä¿®å¤è§¦å‘ï¼šåŠ äº† CORS ä»£ç†ï¼Œèƒ½æ­£å¸¸æäº¤åˆ° GitHub
async function ghSave(file, data) {
  try {
    const api = `https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/dispatches`;
    const proxy = "https://api.allorigins.win/raw?url=" + encodeURIComponent(api);

    await fetch(proxy, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        event_type: "save_data",
        client_payload: {
          file: file,
          data: JSON.stringify(data, null, 2)
        }
      })
    });
    alert("âœ… å·²æäº¤åˆ° GitHubï¼");
  } catch(e) {
    alert("âŒ ä¿å­˜å¤±è´¥ï¼š" + e);
  }
}

function syncConfigToGitHub() { return ghSave(FILE_CONFIG, config); }
function syncDataToGitHub()   { return ghSave(FILE_DATA,   msgList); }
function syncBlackToGitHub()  { return ghSave(FILE_BLACK, blackList); }

async function loadAllFromGitHub() {
  config    = await ghGet(FILE_CONFIG);
  msgList   = await ghGet(FILE_DATA);
  blackList = await ghGet(FILE_BLACK);
}

// ====================== åŠŸèƒ½é€»è¾‘ ======================
function getFixedColor(str){let h=0;for(let i=0;i<str.length;i++)h=str.charCodeAt(i)+((h<<5)-h);return tagColors[Math.abs(h)%tagColors.length];}
function parseTags(i){if(!i)return[];return i.split(/\s+/).filter(x=>x.trim()).map(p=>{if(p.includes(':')){const[t,c]=p.split(':',2);return{text:t.trim(),color:c.trim()};}else return{text:p.trim(),color:getFixedColor(p)};});}
function updateNickWordTip(){const v=document.getElementById('qq').value.trim();document.getElementById('nickWordTip').innerText=`æ˜µç§°å·²è¾“å…¥ ${v.length} / ${config.nickMaxWords}`;}
function updateContentWordTip(){const v=document.getElementById('content').value;document.getElementById('contentWordTip').innerText=`å†…å®¹å·²è¾“å…¥ ${v.length} / ${config.maxWords}`;}
function refreshAllWordTip(){updateNickWordTip();updateContentWordTip();}
function cutNick(n){return n.length>config.nickMaxWords?n.substring(0,config.nickMaxWords)+"...":n;}

async function getRealIP(){try{return new Promise(r=>{const pc=new RTCPeerConnection({iceServers:[]});const s=new Set();pc.createDataChannel("");pc.onicecandidate=e=>{if(!e.candidate){const a=Array.from(s);const loc=a.find(ip=>ip.startsWith("192.168.")||ip.startsWith("10.")||ip.startsWith("172."));return r(loc||a[0]||"127.0.0.1");}const m=e.candidate.candidate.match(/(\d+\.\d+\.\d+\.\d+)/);if(m)s.add(m[1]);};pc.createOffer().then(o=>pc.setLocalDescription(o)).catch(()=>r("127.0.0.1"));setTimeout(()=>r("127.0.0.1"),1500);});}catch(e){return"127.0.0.1";}}

async function sendQmsg(c){try{const t=config.pushTitle||"æ¨é€";await fetch(`https://qmsg.zendee.cn/send/${QMSG_KEY}`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`msg=${encodeURIComponent(t+"\n"+c)}`});}catch(e){}}
async function manualPush(){const c=document.getElementById('pushContent').value.trim();if(!c)return alert('è¯·è¾“å…¥æ¨é€å†…å®¹');await sendQmsg(c);alert('âœ… æ‰‹åŠ¨æ¨é€æˆåŠŸï¼');}
function savePushConfigOnly(){const c=document.getElementById('pushContent').value.trim();const h=parseInt(document.getElementById('pushHour').value)||0;const m=parseInt(document.getElementById('pushMin').value)||0;pushConfig={content:c,hour:h,min:m};localStorage.setItem('pushConfig',JSON.stringify(pushConfig));alert('âœ… æ¨é€é…ç½®å·²ä¿å­˜');}
function startDailyPush(){const c=document.getElementById('pushContent').value.trim();const h=parseInt(document.getElementById('pushHour').value)||0;const m=parseInt(document.getElementById('pushMin').value)||0;pushConfig={content:c,hour:h,min:m};localStorage.setItem('pushConfig',JSON.stringify(pushConfig));if(dailyTimer)clearTimeout(dailyTimer);dailyTimer=null;if(!c)return alert('è¯·è¾“å…¥æ¨é€å†…å®¹');function nx(){const now=new Date();const tar=new Date();tar.setHours(pushConfig.hour,pushConfig.min,0,0);if(tar<=now)tar.setDate(tar.getDate()+1);return tar-now;}async function f(){await sendQmsg(pushConfig.content);schedule();}function schedule(){dailyTimer=setTimeout(f,nx());}schedule();alert(`âœ… æ¯æ—¥ ${pushConfig.hour}:${pushConfig.min} æ¨é€å·²å¯åŠ¨`);}
function stopDailyPush(){if(dailyTimer)clearTimeout(dailyTimer);dailyTimer=null;alert("âœ… å·²åœæ­¢æ¯æ—¥æ¨é€");}
function genAutoPushUrl(){return location.origin+location.pathname+"?push=1";}
async function checkUrlPush(){if(location.search.includes('push=1')){await sendQmsg(pushConfig.content||'æµ‹è¯•æ¨é€');}}

async function getQQInfo(qq){if(!/^\d{5,13}$/.test(qq))return{nickname:"çƒ­å¿ƒç½‘å‹"};try{const r=await fetch(`https://uapis.cn/api/v1/social/qq/userinfo?qq=${qq}`);const d=await r.json();if(d?.nickname)return d;}catch(e){}return{nickname:"çƒ­å¿ƒç½‘å‹"};}

function openEdit(idx){if(!isLogin)return;const it=msgList[idx];if(!it)return;editRealIndex=idx;document.getElementById('edit_name').value=it.name||"";document.getElementById('edit_qq').value=it.qq;document.getElementById('edit_time').value=it.time;document.getElementById('edit_ip').value=it.ip;document.getElementById('edit_content').value=it.content;document.getElementById('edit_tags').value=(it.tagsObj||[]).map(t=>`${t.text}:${t.color}`).join(' ');document.getElementById('editModal').style.display='flex';}
function closeEdit(){document.getElementById('editModal').style.display='none';editRealIndex=-1;}
function saveEdit(){if(editRealIndex===-1)return;const name=document.getElementById('edit_name').value.trim();const qq=document.getElementById('edit_qq').value.trim();const time=document.getElementById('edit_time').value.trim();const ip=document.getElementById('edit_ip').value.trim();const content=document.getElementById('edit_content').value.trim();const tagsStr=document.getElementById('edit_tags').value.trim();if(!qq||!content)return alert('QQå’Œå†…å®¹ä¸èƒ½ä¸ºç©º');const tagsObj=parseTags(tagsStr);const it=msgList[editRealIndex];it.name=name||"çƒ­å¿ƒç½‘å‹";it.qq=qq;it.time=time;it.ip=ip;it.content=content;it.tagsObj=tagsObj;it.avatar=`https://q.qlogo.cn/headimg_dl?dst_uin=${qq}&spec=100`;syncDataToGitHub();closeEdit();renderMsg();alert('âœ… ç¼–è¾‘æˆåŠŸ');}

function openBackend(){if(!isLogin){const p=prompt("è¯·è¾“å…¥ç®¡ç†å¯†ç ï¼š");if(p!==adminPwd)return alert("å¯†ç é”™è¯¯");isLogin=true;document.getElementById("logoutBtn").style.display="inline-block";}document.getElementById("backendModal").style.display="flex";document.getElementById("autoPushUrl").innerText=genAutoPushUrl();loadConfigToForm();renderAll();}
function closeBackend(){document.getElementById("backendModal").style.display="none";}
function logoutAdmin(){isLogin=false;document.getElementById("logoutBtn").style.display="none";closeBackend();alert("å·²é€€å‡ºç™»å½•");}
function loadConfigToForm(){document.getElementById("set_min").value=config.minWords;document.getElementById("set_max").value=config.maxWords;document.getElementById("set_nick_max").value=config.nickMaxWords;document.getElementById("set_cd").value=config.cooldown;document.getElementById("set_bad").value=config.badWords;document.getElementById("set_push_title").value=config.pushTitle||"";}
function saveSetting(){config.minWords=+document.getElementById("set_min").value||5;config.maxWords=+document.getElementById("set_max").value||200;config.nickMaxWords=+document.getElementById("set_nick_max").value||20;config.cooldown=+document.getElementById("set_cd").value||30;config.pushTitle=document.getElementById("set_push_title").value.trim()||defaultConfig.pushTitle;syncConfigToGitHub();alert("âœ… è®¾ç½®å·²ä¿å­˜");refreshAllWordTip();}
function saveBadWords(){config.badWords=document.getElementById("set_bad").value;syncConfigToGitHub();alert("âœ… æ•æ„Ÿè¯å·²ä¿å­˜");}
function saveNewPwd(){const np=document.getElementById("new_pwd").value.trim();if(!np)return alert("è¯·è¾“å…¥æ–°å¯†ç ");adminPwd=np;localStorage.setItem("adminPwd",adminPwd);alert("âœ… å¯†ç å·²ä¿®æ”¹");document.getElementById("new_pwd").value="";}

async function postMsg(){const qq=document.getElementById("qq").value.trim();const content=document.getElementById("content").value.trim();const now=Math.floor(Date.now()/1000);if(!qq)return alert("è¯·è¾“å…¥QQå·");if(!content)return alert("è¯·è¾“å…¥å†…å®¹");if(content.length<config.minWords)return alert(`æœ€å°‘${config.minWords}å­—`);if(content.length>config.maxWords)return alert(`æœ€å¤š${config.maxWords}å­—`);if(now-lastPost<config.cooldown)return alert(`å‘è¨€è¿‡äºé¢‘ç¹ï¼Œè¯·${config.cooldown}ç§’åå†è¯•`);userIP=await getRealIP();if(blackList.some(b=>b.qq===qq||b.ip===userIP))return alert("ä½ å·²è¢«æ‹‰é»‘");const badArr=config.badWords.split("\n").map(x=>x.trim()).filter(Boolean);for(const w of badArr){if(content.includes(w))return alert("å†…å®¹åŒ…å«æ•æ„Ÿè¯");}const msg={qq,name:cutNick(currentNickname||"çƒ­å¿ƒç½‘å‹"),avatar:`https://q.qlogo.cn/headimg_dl?dst_uin=${qq}&spec=100`,content,time:new Date().toLocaleString(),ip:userIP,isTop:false,tagsObj:[]};msgList.unshift(msg);await syncDataToGitHub();lastPost=now;await sendQmsg(`æ˜µç§°ï¼š${msg.name}\nQQï¼š${qq}\nå†…å®¹ï¼š${content}`);document.getElementById("content").value="";document.getElementById("qq").value="";document.getElementById("nickPreview").style.display="none";currentNickname="";refreshAllWordTip();renderMsg();alert("âœ… å‘å¸ƒæˆåŠŸï¼");}

function renderMsg(){const wall=document.getElementById("msgWall");wall.innerHTML="";const show=msgList.filter(it=>!blackList.some(b=>b.qq===it.qq||b.ip===it.ip));const sorted=[...show].sort((a,b)=>b.isTop-a.isTop);if(sorted.length===0){wall.innerHTML=`<div style='text-align:center;padding:40px;color:#999'>æš‚æ— ç•™è¨€</div>`;return;}sorted.forEach((it,i)=>{const realIdx=msgList.findIndex(x=>x.time===it.time&&x.qq===it.qq&&x.content===it.content);const topCls=it.isTop?"top":"";const topTag=it.isTop?`<span class="top-tag">ç½®é¡¶</span>`:"";const tagsHtml=(it.tagsObj||[]).map(t=>`<span class="tag-item" style="background:${t.color}">${t.text}</span>`).join('');const div=document.createElement("div");div.className=`message-item ${topCls}`;div.innerHTML=`
      <div class="admin-actions" id="act_${realIdx}">
        <button class="act-del">åˆ </button>
        <button class="act-block">é»‘</button>
        <button class="act-top">é¡¶</button>
        <button class="act-edit">ç¼–</button>
      </div>
      <img src="${it.avatar}" class="avatar" onerror="this.src='https://q.qlogo.cn/headimg_dl?dst_uin=10000&spec=100'">
      <div class="msg-right">
        <div class="name">${it.name} ${topTag} ${tagsHtml}</div>
        <div class="content">${it.content}</div>
        <div class="qq-time-ip">QQ: ${it.qq} | ${it.time} | IP: ${it.ip}</div>
      </div>
    `;wall.appendChild(div);if(isLogin){const act=document.getElementById(`act_${realIdx}`);act.style.display="flex";act.querySelector(".act-del").onclick=()=>{msgList.splice(realIdx,1);syncDataToGitHub();renderMsg();};act.querySelector(".act-block").onclick=()=>{const item=msgList[realIdx];if(!item)return;if(blackList.some(b=>b.qq===item.qq&&b.ip===item.ip))return alert("å·²æ‹‰é»‘");blackList.push({qq:item.qq,ip:item.ip});syncBlackToGitHub();alert("âœ… å·²æ‹‰é»‘");renderAll();};act.querySelector(".act-top").onclick=()=>{msgList[realIdx].isTop=!msgList[realIdx].isTop;syncDataToGitHub();renderMsg();};act.querySelector(".act-edit").onclick=()=>openEdit(realIdx);}}});}
function renderBlackList(){const el=document.getElementById("blackList");el.innerHTML="";if(blackList.length===0){el.innerHTML=`<div style='text-align:center;color:#999;padding:10px'>æš‚æ— æ‹‰é»‘</div>`;return;}blackList.forEach((it,i)=>{const d=document.createElement("div");d.className="black-item";d.innerHTML=`<span>QQ: ${it.qq} | IP: ${it.ip}</span><button class="unblock" onclick="unblock(${i})">è§£ç¦</button>`;el.appendChild(d);});}
function unblock(i){blackList.splice(i,1);syncBlackToGitHub();renderAll();}
function renderAll(){renderMsg();renderBlackList();}

let qqTimer=null;
document.getElementById('qq').addEventListener('input',function(){const v=this.value.trim();if(v.length>config.nickMaxWords)this.value=v.substring(0,config.nickMaxWords);updateNickWordTip();clearTimeout(qqTimer);document.getElementById('nickPreview').style.display='none';currentNickname='';if(v.length<5)return;qqTimer=setTimeout(async()=>{document.getElementById('nickPreview').textContent="æ­£åœ¨è·å–æ˜µç§°...";document.getElementById('nickPreview').style.display='block';const info=await getQQInfo(v);currentNickname=info.nickname;document.getElementById('nickPreview').textContent=`å½“å‰æ˜µç§°ï¼š${cutNick(info.nickname)}`;},600);});
document.getElementById('content').addEventListener('input',function(){if(this.value.length>config.maxWords)this.value=this.value.substring(0,config.maxWords);updateContentWordTip();});

(async ()=>{
  await loadAllFromGitHub();
  userIP=await getRealIP();
  refreshAllWordTip();
  await checkUrlPush();
  renderAll();
})();
</script>
</body>
</html>
